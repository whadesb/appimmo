<!DOCTYPE html>
<html lang="<%= locale %>">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>UAP Immo | <%= i18n.payment_title %></title>

  <!-- Google Tag Manager -->
  <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-TF7HSC3N');
  </script>
  <!-- Fin Google Tag Manager -->

  <!-- CSS -->
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/styles-main.css" rel="stylesheet">
  <link href="/css/bootstrap-icons.css" rel="stylesheet">

  <style>
    .form-container {
        max-width: 600px;
        margin: 50px auto;
        padding: 30px;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
    }
    .form-container h4 {
        margin-bottom: 25px;
        color: #333;
        font-weight: 600;
    }
    .form-text {
        margin-bottom: 15px;
        font-size: 1rem;
        color: #555;
    }
    
    /* INFO BOX STYLE */
    .user-info-box {
        background-color: #f8f9fa;
        border-left: 4px solid #52566f;
        padding: 15px;
        margin-bottom: 25px;
        border-radius: 4px;
    }
    .user-info-box p {
        margin-bottom: 5px;
        font-size: 0.95rem;
    }
    .user-info-box strong {
        color: #52566f;
        width: 80px;
        display: inline-block;
    }

    #paypal-button-container {
        margin-top: 0; 
        width: 100%;
    }

    .new-section {
        padding: 60px 0;
        background-color: #f0f2f5;
    }
    .hero-section {
        padding-top: 100px;
    }
    .btn-primary {
        background-color: #52566f;
        border-color: #52566f;
    }
    .btn-primary:hover {
        background-color: #3e4153;
        border-color: #3e4153;
    }

    /* --- STYLE BOUTON BITCOIN --- */
    .btn-btc {
        background-color: #F7931A;
        border-color: #F7931A;
        color: #fff;
        font-weight: 600;
        width: 100%;
        min-height: 45px; 
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }
    .btn-btc:hover {
        background-color: #d87d10;
        border-color: #d87d10;
        color: #fff;
    }

    .navbar { background-color: #C4B990; }
    .navbar .navbar-brand, .navbar .nav-link, .navbar .navbar-icon { color: #000; }
    .navbar .navbar-icon { font-size: 1.5rem; }
    .navbar .btn-outline-dark { margin-right: 12px; }
    .lang-flag {
        width: 24px; height: 16px; background-size: contain;
        background-repeat: no-repeat; background-position: center;
        display: inline-block; flex-shrink: 0;
    }
    .lang-fr { background-image: url('https://flagcdn.com/fr.svg'); }
    .lang-en { background-image: url('https://flagcdn.com/gb.svg'); }

    .ticket-style {
        background-color: #fff;
        border: 2px dashed #ccc;
        padding: 20px;
        font-family: Arial, sans-serif;
        line-height: 1.6;
        border-radius: 8px;
    }
    .ticket-style p {
        font-size: 1rem;
        margin-bottom: 12px;
        color: #333;
        display: flex;
        justify-content: space-between;
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
    }
    .ticket-style p:last-child { border-bottom: none; }

    @media (max-width: 767px) {
        .form-container {
            margin: 20px auto !important;
            padding: 20px !important;
        }
        .container { padding-top: 40px !important; }
    }
    
    @media (max-width: 991.98px) {
      .mobile-lang-selector { display: flex !important; align-items: center; gap: 8px; }
      .desktop-lang-selector { display: none !important; }
    }
    @media (min-width: 992px) {
      .mobile-lang-selector { display: none !important; }
    }
  </style>    
</head>
<body id="top">

<noscript>
  <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TF7HSC3N"
  height="0" width="0" style="display:none;visibility:hidden"></iframe>
</noscript>

<main>
<% let cleanPath = currentPath.replace(/^\/(fr|en)/, '') || '/'; %>
<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg fixed-top">
  <div class="container">
    <a class="navbar-brand" href="/<%= locale %>">
      <span>UAP Immo</span>
    </a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
      aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-lg-5 me-lg-auto">
        <li class="nav-item">
          <a class="nav-link" href="/<%= locale %>"><%= i18n.menu.home %></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/<%= locale %>/contact"><%= i18n.menu.contact %></a>
        </li>

        <% if (isAuthenticated) { %>
          <li class="nav-item d-lg-none">
            <a class="nav-link" href="/<%= locale %>/user"><i class="bi bi-person-circle"></i> <%= locale === 'fr' ? 'Mon compte' : 'My Account' %></a>
          </li>
          <li class="nav-item d-lg-none">
            <form action="/logout" method="POST">
              <button class="nav-link btn btn-link text-start w-100" type="submit" style="border: none; background: none;">
                <i class="bi bi-box-arrow-right"></i> <%= locale === 'fr' ? 'Déconnexion' : 'Logout' %>
              </button>
            </form>
          </li>
        <% } else { %>
        <% } %>
      </ul>

      <div class="d-none d-lg-flex align-items-center">
        <% if (isAuthenticated) { %>
          <a href="/<%= locale %>/user" class="btn btn-outline-dark rounded-pill px-3 py-1 me-2 d-flex align-items-center gap-2">
            <i class="bi bi-person-circle"></i>
            <span><%= locale === 'fr' ? 'Mon compte' : 'My Account' %></span>
          </a>
          <form action="/logout" method="POST" class="d-inline">
            <button type="submit" class="btn btn-outline-dark rounded-pill px-3 py-1 d-flex align-items-center gap-2">
              <i class="bi bi-box-arrow-right"></i>
              <span><%= locale === 'fr' ? 'Déconnexion' : 'Logout' %></span>
            </button>
          </form>
        <% } else { %>
          <a href="/<%= locale %>/login" class="btn btn-outline-dark rounded-pill px-3 py-1 me-3 d-flex align-items-center gap-2">
            <i class="bi bi-person-fill"></i>
            <span><%= locale === 'fr' ? 'Connexion' : 'Login' %></span>
          </a>
        <% } %>
      </div>

      <div class="ms-3 d-none d-lg-block">
        <div class="dropdown">
          <button class="btn btn-light border rounded-pill px-3 py-1 d-flex align-items-center gap-2" type="button"
            data-bs-toggle="dropdown" aria-expanded="false">
            <span class="lang-flag <%= locale === 'fr' ? 'lang-fr' : 'lang-en' %>"></span>
            <i class="bi bi-chevron-down small"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end shadow">
            <% if (locale === 'fr') { %>
              <li><a class="dropdown-item d-flex align-items-center gap-2" href="/en<%= cleanPath %>"><span class="lang-flag lang-en"></span> English</a></li>
            <% } else { %>
              <li><a class="dropdown-item d-flex align-items-center gap-2" href="/fr<%= cleanPath %>"><span class="lang-flag lang-fr"></span> Français</a></li>
            <% } %>
          </ul>
        </div>
      </div>
    </div>
  </div>
</nav>

<main class="container" style="padding-top: 100px;">
  <div class="row">
    
    <!-- COLONNE GAUCHE : PAIEMENT -->
    <div class="col-lg-6 col-12">
      <div class="form-container">
        <h4><%= i18n.payment_title %></h4>
        
        <p class="form-text"><%= i18n.payment_description_1 %></p>
        <p class="form-text"><%= i18n.payment_description_2 %></p>

        <!-- BLOC INFORMATIONS CLIENT -->
        <div class="user-info-box">
            <h6 class="mb-3" style="color: #000; font-weight: 600;"><i class="bi bi-person-lines-fill me-2"></i>Vos informations de facturation</h6>
            <p><strong>Nom :</strong> <%= user.lastName.toUpperCase() %></p>
            <p><strong>Prénom :</strong> <%= user.firstName %></p>
            <p><strong>Email :</strong> <%= user.email %></p>
            
            <!-- FORMULAIRE ADRESSE INTEGRE -->
            <div id="address-form" class="mt-3 pt-3 border-top border-secondary">
                <p class="mb-2"><strong>Adresse :</strong></p>
                <div class="row g-2">
                    <div class="col-12">
                        <input type="text" id="street" class="form-control form-control-sm" placeholder="N° et Rue" value="<%= user.billingAddress ? user.billingAddress.street : '' %>" required>
                    </div>
                    <div class="col-md-6">
                        <input type="text" id="postalCode" class="form-control form-control-sm" placeholder="Code Postal" value="<%= user.billingAddress ? user.billingAddress.zipCode : '' %>" required>
                    </div>
                    <div class="col-md-6">
                        <input type="text" id="city" class="form-control form-control-sm" placeholder="Ville" value="<%= user.billingAddress ? user.billingAddress.city : '' %>" required>
                    </div>
                    <div class="col-12">
                        <input type="text" id="country" class="form-control form-control-sm" placeholder="Pays" value="<%= user.billingAddress ? user.billingAddress.country : '' %>" required>
                    </div>
                </div>
            </div>
        </div>

        <!-- BOUTON DE VALIDATION -->
        <div id="validation-step">
             <p class="form-text text-muted mb-3"><small><i class="bi bi-info-circle"></i> Confirmez vos coordonnées pour voir les options de paiement.</small></p>
             <button id="btn-validate-info" class="btn btn-primary w-100 py-2 fw-bold">
                 Confirmer l'adresse et Payer
             </button>
             <div id="save-msg" class="text-center mt-2" style="display:none;"></div>
        </div>
        
        <!-- ZONE DE PAIEMENT (CACHÉE PAR DÉFAUT) -->
        <div id="payment-options" class="collapse mt-4">
            <div class="alert alert-success border text-center mb-4">
                <i class="bi bi-check-circle-fill me-2"></i> Adresse validée. Choisissez votre moyen de paiement :
            </div>
            
            <div class="row g-3 align-items-start">
                <!-- Colonne PayPal -->
                <div class="col-md-6">
                    <div id="paypal-button-container"></div>
                </div>
                
                <!-- Colonne Bitcoin -->
                <div class="col-md-6">
                    <button id="btc-button" class="btn btn-btc">
                        <i class="bi bi-currency-bitcoin fs-5 me-2"></i> <%= i18n.pay_with_btc %>
                    </button>
                </div>
            </div>
        </div>
        
        <input type="hidden" id="propertyId" value="<%= propertyId %>">
      </div>
    </div>
    
    <!-- COLONNE DROITE : RÉCAPITULATIF -->
    <div class="col-lg-6 col-12">
      <div class="form-container">
        <h4><%= i18n.order_summary %></h4>
        <div class="ticket-style">
            <p><span><%= i18n.duration %> :</span> <strong>90 jours</strong></p>
            <p><span>ID Annonce :</span> <strong><%= propertyId %></strong></p>
            <p><span>Prix HT :</span> <strong>500,00 €</strong></p>
            <p><span>TVA (0%) :</span> <strong>0,00 €</strong></p>
            <hr style="margin: 10px 0; border-color: #000;">
            <p style="font-size: 1.2rem;"><span><%= i18n.total %> :</span> <strong><%= Number(500).toLocaleString(locale === 'en' ? 'en-US' : 'fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %>€</strong></p>
        </div>
        <div class="text-center mt-3">
            <small class="text-muted"><i class="bi bi-lock-fill"></i> Paiement 100% sécurisé</small>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Footer -->
<footer class="site-footer section-padding">
  <div class="container">
    <div class="row">
      <div class="col-lg-3 col-12 mb-4 pb-2">
        <a class="navbar-brand mb-2" href="/<%= locale %>"><span>UAP Immo</span></a>
      </div>
      <div class="col-lg-3 col-md-4 col-6">
        <h6 class="site-footer-title mb-3"><%= i18n.footer.informations %></h6>
        <ul class="site-footer-links">
          <li class="site-footer-link-item"><a href="/<%= locale %>" class="site-footer-link"><%= i18n.menu.home %></a></li>
          <li class="site-footer-link-item"><a href="/<%= locale %>/cgu" class="site-footer-link">CGU</a></li>
        </ul>
      </div>
      <div class="col-lg-3 col-md-4 col-6">
        <h6 class="site-footer-title mb-3"><%= i18n.footer.access %></h6>
        <ul class="site-footer-links">
          <li class="site-footer-link-item"><a href="/<%= locale %>/contact" class="site-footer-link"><%= i18n.menu.contact %></a></li>
        </ul>
      </div>
      <div class="col-lg-3 col-md-4 col-12 mt-4 mt-lg-0 ms-auto">
        <!-- Sélecteur de langue footer -->
      </div>
    </div>
    <p class="copyright-text mt-lg-5 mt-4">Copyright © 2025 UAP Company. <%= i18n.footer && i18n.footer.all_rights ? i18n.footer.all_rights : 'Tous droits réservés.' %></p>
  </div>
</footer>

<!-- MODAL BTCPAY -->
<div class="modal fade" id="btcpay-modal" tabindex="-1" aria-labelledby="btcpayModalLabel">
  <div class="modal-dialog modal-xl modal-dialog-centered" style="max-width: 900px;"> 
    <div class="modal-content" style="height: 95vh;">
      <div class="modal-header">
        <h5 class="modal-title" id="btcpayModalLabel"><%= i18n.pay_with_btc %></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body p-0" style="height: calc(100% - 56px);">
        <iframe id="btcpay-iframe" src="about:blank" style="border:0;width:100%;height:100%;" allow="payment"></iframe>
      </div>
    </div>
  </div>
</div>

<script src="/js/bootstrap.bundle.min.js"></script>
<!-- SDK PayPal -->
<script src="https://www.paypal.com/sdk/js?client-id=<%= PAYPAL_CLIENT_ID %>&currency=EUR&intent=capture&components=buttons&disable-funding=card,credit,bancontact,blik,eps,giropay,ideal,mybank,p24,sepa,sofort"></script>

<script>
    // --- LOGIQUE DE SAUVEGARDE ADRESSE ---
    document.getElementById('btn-validate-info').addEventListener('click', async function() {
        const btn = this;
        const msg = document.getElementById('save-msg');
        
        const street = document.getElementById('street').value;
        const zipCode = document.getElementById('postalCode').value;
        const city = document.getElementById('city').value;
        const country = document.getElementById('country').value;

        if (!street || !zipCode || !city || !country) {
            alert("Veuillez remplir tous les champs de l'adresse.");
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sauvegarde...';

        try {
            const response = await fetch('/api/user/update-address', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ street, zipCode, city, country })
            });
            
            const result = await response.json();

            if (result.success) {
                // Cacher le bouton et montrer les options de paiement
                document.getElementById('validation-step').style.display = 'none';
                
                var paymentOptions = document.getElementById('payment-options');
                var bsCollapse = new bootstrap.Collapse(paymentOptions, {
                    toggle: true
                });
            } else {
                alert('Erreur: ' + result.message);
                btn.disabled = false;
                btn.innerHTML = "Confirmer l'adresse et Payer";
            }
        } catch (error) {
            console.error(error);
            alert('Erreur de connexion');
            btn.disabled = false;
            btn.innerHTML = "Confirmer l'adresse et Payer";
        }
    });
</script>

<script>
// --- PAYPAL LOGIC (Reste inchangée) ---
function initPaypal() {
  paypal.Buttons({
    style: {
        layout: 'horizontal', // Force un layout simple
        tagline: false,
        height: 45 // Match height with BTC button approx
    },
    createOrder: function (data, actions) {
      return actions.order.create({
        purchase_units: [{
          amount: { currency_code: 'EUR', value: '500.00' },
          description: 'Paiement annonce immobilière UAP'
        }]
      });
    },
    onApprove: function (data, actions) {
      return actions.order.capture().then(async function(details) {
        const propertyId = document.getElementById('propertyId')?.value || null;
        const cap = details?.purchase_units?.[0]?.payments?.captures?.[0];

        const res = await fetch('/paypal/mark-paid', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({
            orderID: data.orderID,
            propertyId,
            amount: cap?.amount?.value || '500.00',
            currency: cap?.amount?.currency_code || 'EUR',
            captureId: cap?.id
          })
        });

        const text = await res.text();
        let json;
        try {
          json = JSON.parse(text);
        } catch (e) {
          console.error('Réponse non-JSON:', text);
          alert('Erreur serveur.');
          return;
        }

        if (res.ok && json.success && json.redirectUrl) {
          window.location.href = json.redirectUrl;
        } else {
          alert('Erreur : ' + (json.message || 'Réponse invalide.'));
        }
      });
    }
  }).render('#paypal-button-container');
}

(function waitForPaypal(){
  if (window.paypal && paypal.Buttons) {
    initPaypal();
  } else {
    setTimeout(waitForPaypal, 150);
  }
})();
</script>

<script>
/* ---------- BTCPay (Bitcoin) ---------- */
document.getElementById('btc-button').addEventListener('click', async function () {
  const btn = this;
  const originalText = btn.innerHTML;
  
  // 1. Mise à jour UI (Chargement)
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Chargement...';

  const propertyIdEl = document.getElementById('propertyId');
  const propertyId = propertyIdEl ? propertyIdEl.value : null;

  try {
      // 2. Création de la facture via votre serveur
      const response = await fetch('/process-btcpay-payment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ propertyId: propertyId, amount: '500.00' })
      });

      const result = await response.json().catch(() => ({}));

      if (response.ok && result.success && result.invoiceUrl) {
          // Mise à jour libellé
          const pm = document.getElementById('payment-method');
          if (pm) pm.textContent = '<%= i18n.pay_with_btc %>';

          // Injection Iframe
          const iframe = document.getElementById('btcpay-iframe');
          const modalEl = document.getElementById('btcpay-modal');
          
          if (iframe && modalEl && window.bootstrap) {
             iframe.src = result.invoiceUrl;
             const modal = new bootstrap.Modal(modalEl);
             modal.show();
          } else {
             // Fallback si problème modale
             window.location.href = result.invoiceUrl;
          }
      } else {
          alert('Erreur : ' + (result.message || 'Impossible de créer la facture.'));
      }
  } catch (err) {
      console.error('Erreur BTC Pay :', err);
      alert("Une erreur technique est survenue.");
  } finally {
      // 3. Rétablissement bouton
      btn.disabled = false;
      btn.innerHTML = originalText;
  }
});
</script>

<%- include('partials/cookie_banner') %>

</body>
</html>

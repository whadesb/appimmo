<!DOCTYPE html>
<html lang="<%= locale %>">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="theme-color" content="#C4B990"> 
  <title>UAP Immo | <%= i18n.title %></title>
  
  <!-- Google Tag Manager -->
  <script>
  (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id=' + i + dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-TF7HSC3N');
  </script>
  <!-- Fin Google Tag Manager -->

  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles-main.css">
  
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #fff;
      color: #212529;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    /* NAVBAR STYLES */
    .navbar { background-color: #C4B990; }
    .navbar .navbar-brand, .navbar .nav-link, .navbar .navbar-icon { color: #000; }
    .navbar .navbar-icon { font-size: 1.5rem; }
    .navbar .btn-outline-dark { margin-right: 12px; }
    
    /* FLAGS */
    .lang-flag {
      width: 24px; height: 16px; 
      background-size: contain; background-repeat: no-repeat; background-position: center;
      display: inline-block; flex-shrink: 0;
    }
    .lang-fr { background-image: url('https://flagcdn.com/fr.svg'); }
    .lang-en { background-image: url('https://flagcdn.com/gb.svg'); }

    /* MAIN LAYOUT */
    main {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      /* Padding desktop par défaut */
      padding: 120px 20px 60px; 
      background-color: #fff;
    }

    /* CONTAINER 2FA */
    .twofa-container {
      max-width: 1000px; 
      width: 100%;
      margin: auto;
      display: flex;
      flex-direction: row;
      gap: 60px;
      /* MODIFICATION ICI : Centrage vertical des deux colonnes */
      align-items: center; 
      justify-content: space-between;
    }

    .twofa-left {
      flex: 1;
    }

    .twofa-left h2 { font-size: 1.9rem; font-weight: 600; margin-bottom: 14px; }
    .twofa-left p { font-size: 1rem; color: #6c757d; margin-bottom: 20px; }
    .twofa-left ul {
      list-style: none; padding-left: 16px; border-left: 3px solid #dee2e6; margin-top: 12px;
    }
    .twofa-left li {
      font-size: 0.95rem; margin-bottom: 8px; color: #444; position: relative;
    }
    .twofa-left li::before { content: "✓"; color: #8f97c4; margin-right: 8px; }

    .twofa-form-wrapper {
      flex: 0 0 360px; 
      background-color: #f8f9fa;
      padding: 28px; 
      border-radius: 10px;
      border: 1px solid #e2e6ea;
    }

    /* CLAVIER ET INPUTS */
    #code-display {
      height: 46px; 
      background: #fff;
      border: 1px solid #ced4da;
      border-radius: 8px;
      line-height: 46px;
      font-size: 1.5rem;
      font-weight: 600;
      text-align: center;
      letter-spacing: 6px;
    }

    #numeric-keypad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px; 
      max-width: 100%; 
      margin: 16px auto; 
    }

    #numeric-keypad button {
      font-size: 1.4rem; 
      padding: 12px 0; 
      border-radius: 8px;
      border: 1px solid #ced4da;
      background-color: #ffffff;
      transition: transform 0.1s ease, box-shadow 0.1s ease;
      touch-action: manipulation; 
    }

    #numeric-keypad button:active {
      transform: scale(0.97);
      background-color: #f0f0f0;
    }

    .btn-primary {
      width: 100%; background-color: #8f97c4; border: none; padding: 12px; 
      font-size: 1rem; font-weight: 600; border-radius: 8px;
    }
    .btn-primary:hover { background-color: #7a81b8; }
    
    .qr-code-container img {
      max-width: 180px; 
      height: auto; display: block; margin: auto;
      border: 1px solid #eee; padding: 8px; background: white; border-radius: 8px;
    }

    /* --- RESPONSIVE MOBILE / TABLETTE --- */
    @media (max-width: 991px) {
      main {
        padding-top: 90px;
        padding-bottom: 40px;
        align-items: flex-start; 
      }

      .twofa-container {
        flex-direction: column; 
        gap: 30px;
        padding: 0 15px;
        /* Sur mobile, on peut vouloir aligner à gauche ou garder centré. 
           align-items: center ici centrera horizontalement les blocs empilés. */
      }

      .twofa-left {
        width: 100%;
        text-align: center;
        order: 1; 
      }
      
      .twofa-left ul {
        text-align: left;
        margin: 0 auto;
        max-width: 350px; 
      }

      .twofa-form-wrapper {
        width: 100%; 
        flex: none; 
        max-width: 450px; 
        margin: 0 auto;
        order: 2; 
        padding: 20px;
      }
      
      #numeric-keypad button {
        padding: 18px 0; 
        font-size: 1.6rem;
      }
      
      #code-display {
        height: 50px;
        line-height: 50px;
      }
    }
    
    /* Sélecteur de langue */
    .language-switcher .dropdown-menu { min-width: 140px; }
    .language-switcher .btn-light { background-color: white; border-color: #ddd; }
  </style>
</head>
<body id="top">

<noscript>
  <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TF7HSC3N"
  height="0" width="0" style="display:none;visibility:hidden"></iframe>
</noscript>

<main>
<% let cleanPath = currentPath.replace(/^\/(fr|en)/, '') || '/'; %>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg fixed-top">
  <div class="container">
    <a class="navbar-brand" href="/<%= locale %>"><span>UAP Immo</span></a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link" href="/<%= locale %>"><%= i18n.menu.home %></a></li>
        <li class="nav-item"><a class="nav-link" href="/<%= locale %>/contact"><%= i18n.menu.contact %></a></li>
      </ul>

      <!-- Desktop Language Selector -->
      <div class="dropdown language-switcher ms-auto d-none d-lg-block">
        <button class="btn btn-light border rounded-pill px-3 py-1 d-flex align-items-center gap-2" type="button" data-bs-toggle="dropdown" aria-expanded="false">
          <span class="lang-flag <%= locale === 'fr' ? 'lang-fr' : 'lang-en' %>"></span>
          <i class="bi bi-chevron-down small"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-end shadow">
          <% if (locale === 'fr') { %>
            <li><a class="dropdown-item d-flex align-items-center gap-2" href="/en<%= cleanPath %>"><span class="lang-flag lang-en"></span> English</a></li>
          <% } else { %>
            <li><a class="dropdown-item d-flex align-items-center gap-2" href="/fr<%= cleanPath %>"><span class="lang-flag lang-fr"></span> Français</a></li>
          <% } %>
        </ul>
      </div>
    </div>
  </div>
</nav>

<div class="twofa-container">
    <!-- Colonne gauche : Instructions -->
    <div class="twofa-left">
      <h2><%= i18n.instruction %></h2>
      <p class="text-muted"><%= i18n.step_title %></p>
      <ul>
        <% i18n.steps.forEach(function(step) { %>
          <li><%= step %></li>
        <% }); %>
      </ul>
    </div>

    <!-- Colonne droite : Formulaire et Clavier -->
    <div class="twofa-form-wrapper">
      <% if (messages.error && messages.error.length > 0) { %>
        <div class="alert alert-danger text-center py-2 mb-3" style="font-size: 0.9rem;"><%= messages.error[0] %></div>
      <% } %>
      <% if (messages.success && messages.success.length > 0) { %>
        <div class="alert alert-success text-center py-2 mb-3" style="font-size: 0.9rem;"><%= messages.success[0] %></div>
      <% } %>

      <form action="/<%= locale %>/enable-2fa" method="POST">
        <!-- Code QR -->
        <div class="text-center mb-3 qr-code-container">
          <img src="<%= qrCode %>" alt="QR Code 2FA">
          <p class="mt-2 mb-0 small text-muted" style="font-size: 0.85rem;"><strong><%= i18n.secret_label %> :</strong></p>
          <code class="d-block mb-2" style="font-size: 0.95em; color: #333; word-break: break-all;"><%= user.twoFactorSecret %></code>
        </div>

        <!-- Zone de code -->
        <div id="code-display"></div>
        <input type="hidden" name="code" id="hidden-code">

        <!-- Clavier Numérique -->
        <div id="numeric-keypad">
            <!-- Généré par JS -->
        </div>

        <!-- Boutons -->
        <div class="row g-2 mt-3">
            <div class="col-6">
                 <button type="button" id="clear-code" class="btn btn-outline-secondary w-100 py-2" style="font-size: 0.95rem;">
                    <i class="bi bi-backspace"></i> <%= i18n.menu && i18n.menu.clear_button ? i18n.menu.clear_button : (locale === 'fr' ? 'Effacer' : 'Clear') %>
                 </button>
            </div>
            <div class="col-6">
                <button id="submit-code" type="submit" class="btn btn-primary w-100 py-2" style="font-size: 0.95rem;" disabled>
                    <%= i18n.menu && i18n.menu.submit_button ? i18n.menu.submit_button : i18n.verify %>
                </button>
            </div>
        </div>
      </form>
    </div>
</div>

</main>

<!-- Footer -->
<footer class="site-footer section-padding">
  <div class="container">
    <div class="row">
      <div class="col-lg-3 col-12 mb-4 pb-2">
        <a class="navbar-brand mb-2" href="/<%= locale %>"><span>UAP Immo</span></a>
      </div>
      <div class="col-lg-3 col-md-4 col-6">
        <h6 class="site-footer-title mb-3"><%= i18n.footer && i18n.footer.information_title ? i18n.footer.information_title : 'Informations' %></h6>
        <ul class="site-footer-links">
          <li class="site-footer-link-item"><a href="/<%= locale %>" class="site-footer-link"><%= i18n.menu.home %></a></li>
          <li class="site-footer-link-item"><a href="/<%= locale %>/cgu" class="site-footer-link">CGU</a></li>
        </ul>
      </div>
      <div class="col-lg-3 col-md-4 col-6">
        <h6 class="site-footer-title mb-3"><%= i18n.footer && i18n.footer.access_title ? i18n.footer.access_title : 'Accès' %></h6>
        <ul class="site-footer-links">
          <li class="site-footer-link-item"><a href="/<%= locale %>/contact" class="site-footer-link"><%= i18n.menu.contact %></a></li>
        </ul>
      </div>
      <div class="col-lg-3 col-md-4 col-12 mt-4 mt-lg-0 ms-auto">
         <!-- Sélecteur langue Mobile (si besoin) ou vide -->
      </div>
    </div>
    <p class="copyright-text mt-lg-5 mt-4">Copyright © 2025 UAP Company. <%= i18n.footer && i18n.footer.all_rights ? i18n.footer.all_rights : 'Tous droits réservés.' %></p>
  </div>
</footer>

<script src="/js/bootstrap.bundle.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const keypad = document.getElementById("numeric-keypad");
    const codeDisplay = document.getElementById("code-display");
    const hiddenCode = document.getElementById("hidden-code");
    const clearBtn = document.getElementById("clear-code");
    const submitBtn = document.getElementById("submit-code");

    // Génération aléatoire des chiffres pour la sécurité
    function generateRandomDigits() {
      const digits = [...Array(10).keys()];
      for (let i = digits.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [digits[i], digits[j]] = [digits[j], digits[i]];
      }
      return digits;
    }

    function renderKeypad() {
      keypad.innerHTML = "";
      const digits = generateRandomDigits();
      digits.forEach(digit => {
        const btn = document.createElement("button");
        btn.className = "btn"; // Style de base
        btn.textContent = digit;
        btn.type = "button";
        btn.setAttribute("aria-label", `Chiffre ${digit}`);
        
        // Gestionnaire tactile et clic
        const handleInput = (e) => {
            e.preventDefault(); // Empêche le double tap zoom
            enterDigit(digit);
            // Petit effet visuel
            btn.style.backgroundColor = "#e2e6ea";
            setTimeout(() => btn.style.backgroundColor = "#fff", 100);
        };

        btn.addEventListener('click', handleInput);
        keypad.appendChild(btn);
      });
    }

    function enterDigit(digit) {
      if (hiddenCode.value.length < 6) {
        hiddenCode.value += digit;
        // Met à jour l'affichage avec des points ou étoiles
        codeDisplay.textContent = "•".repeat(hiddenCode.value.length);
      }
      submitBtn.disabled = hiddenCode.value.length !== 6;
    }

    clearBtn.addEventListener('click', () => {
      hiddenCode.value = "";
      codeDisplay.textContent = "";
      submitBtn.disabled = true;
    });
    
    // Soumission
    submitBtn.addEventListener('click', function(e) {
        e.preventDefault();
        if (hiddenCode.value.length === 6) {
             this.disabled = true;
             this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
             this.closest('form').submit();
        }
    });

    renderKeypad();
  });
</script>

</body>
</html>

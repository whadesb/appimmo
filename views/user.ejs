<!doctype html>
<html lang="<%= locale %>">
<head>
    <meta charset="utf-8">
<!-- Google Tag Manager -->
<script>
(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id=' + i + dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-TF7HSC3N');
</script>
<!-- Fin Google Tag Manager -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#C4B990">
    <title>UAP Immo | <%= i18n.my_profile %></title>
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/bootstrap-icons.css" rel="stylesheet">
    <link rel="preload" href="/css/styles-main.css" as="style">
    <link rel="stylesheet" href="/css/styles-main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        html, body {
            height: 100%;
        }
.lang-flag {
      width: 24px;
      height: 16px;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      display: inline-block;
      flex-shrink: 0;
    }
    .lang-fr {
      background-image: url('https://flagcdn.com/fr.svg');
    }
    .lang-en {
      background-image: url('https://flagcdn.com/gb.svg');
    }
    .lang-es {
      background-image: url('/images/flags/es.svg');
    }
    .lang-pt {
      background-image: url('/images/flags/pt.svg');
    }
        :root {
            --dashboard-table-row-height: 56px;
        }
        body {
            display: flex;
            flex-direction: column;
            font-family: 'Arial', sans-serif;
            background-color: #f8f9fa;
            margin: 0;
        }
        h3 {
            color: #000;
            text-align: left;
        }
        .navbar {
            background-color: #C4B990;
            margin-bottom: 20px;
        }
        .navbar .navbar-brand, .navbar .nav-link, .navbar .navbar-icon {
            color: #000;
        }
        .navbar .navbar-icon {
            color: #000;
        }
        .main-section {
            flex: 1;
            padding: 20px;
            background-color: #fff;
            margin-left: 10px;
            min-height: 500px;
        }
        .main-section .card {
            border: none;
            box-shadow: none;
        }
        .dashboard-layout {
            flex-wrap: nowrap;
        }
        .table tbody tr {
            min-height: var(--dashboard-table-row-height);
            height: var(--dashboard-table-row-height);
        }
        .table tbody tr > * {
            vertical-align: middle;
            padding-top: 0.6rem;
            padding-bottom: 0.6rem;
        }
        .table tbody tr > * .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            white-space: nowrap;
        }
        .table-action-buttons {
            display: flex;
            
            align-items: center;
            gap: 0.35rem;
        }
        @media (max-width: 991.98px) {
            .dashboard-layout {
                flex-wrap: wrap;
            }
        }
        .navbar-nav .nav-link.admin-nav-link {
            background-color: #fff;
            color: #000 !important;
            border-radius: 999px;
            padding: 0.4rem 0.9rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            margin-left: 0.5rem;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            font-weight: 600;
        }
        .navbar-nav .nav-link.admin-nav-link i {
            color: inherit;
        }
        .navbar-nav .nav-link.admin-nav-link:hover,
        .navbar-nav .nav-link.admin-nav-link:focus {
            background-color: #f5f5f5;
            color: #000 !important;
        }
        @media (max-width: 991.98px) {
            .navbar-nav .nav-link.admin-nav-link {
                margin-left: 0;
                margin-bottom: 0.5rem;
                border-radius: 12px;
            }
        }
        .sidebar .admin-sidebar-link {
            background-color: #fff;
            color: #000000 !important;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .sidebar .admin-sidebar-link i {
            color: inherit;
        }
        .sidebar .admin-sidebar-link:hover,
        .sidebar .admin-sidebar-link:focus {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2);
        }
button.disabled {
  pointer-events: none;
  opacity: 0.7;
  cursor: not-allowed;
}
#statsDetails {
  overflow: hidden;
  max-height: 0;
  opacity: 0;
  transition: max-height 0.5s ease, opacity 0.4s ease;
}

#statsDetails.show {
  max-height: 1000px; /* suffisamment grand pour ton contenu */
  opacity: 1;
}

.progress {
    background-color: #d7d7d7 !important; 
    width: 7.6rem;
}
.form-section {
  margin-top: 30px;
  padding-top: 20px;
  border-top: 1px solid #dee2e6;
}
.tooltip-inner {
  background-color: #000 !important; /* fond noir */
  color: #fff !important;            /* texte blanc */
  font-size: 13px;
  border-radius: 4px;
  padding: 6px 10px;
  box-shadow: none !important;
 max-width: 220px !important;  /* Augmente si nécessaire */
  white-space: normal !important;
  word-wrap: break-word !important;
  overflow-wrap: break-word !important;
  text-align: left !important;
}
.tooltip-arrow::before {
  border-top-color: #000 !important; /* flèche noire */
}

.form-section:first-of-type {
  border-top: none;
  margin-top: 0;
  padding-top: 0;
}

.form-section h6 {
  font-weight: bold;
  font-size: 1.2rem;
  color: #444;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.form-section h6 i {
  color: #8f97c4;
  font-size: 20px;
}

.form-text {
  font-size: 0.875rem;
  color: #6c757d;
}
.text-black {
  color: #000 !important;
}

   .sidebar {
            background-color: #8f97c4;
            border-radius: 60px;
            box-shadow: 2px 2px 2px rgba(0, 0, 0, 0.8);
            padding: 20px;
            width: 60px;
            height: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: sticky;
            top: 20px;
        
        }
        .sidebar a {
            margin: 10px 0;
            color: #000;
            font-size: 24px;
            text-decoration: none;
        }
        .sidebar a:hover {
            color: #000;
        }
.tooltip-container {
  position: relative;
  display: inline-block;
  cursor: help;
}

.tooltip-text {
  visibility: hidden;
  width: 180px;
  background-color: rgba(0, 0, 0, 0.8);
  color: #fff;
  text-align: center;
  padding: 6px;
  border-radius: 5px;
  position: absolute;
  z-index: 10;
  bottom: 120%;
  left: 50%;
  transform: translateX(-50%);
  opacity: 0;
  transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
  font-size: 13px;
  line-height: 1.4;
}
.tooltip.show {
  outline: none !important;
  box-shadow: none !important;
}
.has-tooltip:focus,
[data-bs-toggle="tooltip"]:focus {
  outline: none !important;
  box-shadow: none !important;
}

.tooltip-text::after {
  content: "";
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  border-width: 5px;
  border-style: solid;
  border-color: rgba(0, 0, 0, 0.8) transparent transparent transparent;
}

.tooltip-container:hover .tooltip-text {
  visibility: visible;
  opacity: 1;
  transform: translateX(-50%) translateY(-5px);
}

#detailsModal .modal-body {
  font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
  color: #333; /* Finement foncé */
  font-size: 15px;
  line-height: 1.6;
}

#detailsModal .modal-body p {
  font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
  color: #212529; /* même que le titre Bootstrap */
  font-size: 1rem;
  line-height: 1.6;
  border-bottom: 1px solid #dee2e6;
  padding-bottom: 6px;
  margin-bottom: 12px;
}

#detailsModal .modal-body strong {
  color: #000;
  font-weight: 600;
}


        .footer {
            background-color: #343a40;
            color: #fff;
            padding: 20px 0;
        }
        .btn-custom {
            background-color: #8f97c4;
            color: #000;
            border: none;
        }
        .btn-custom:hover {
            background-color: #8f97c4;
            color: #000;
        }
        .btn-custom i {
            font-size: 24px;
        }
        .tooltip {
            position: absolute;
            color: #000;
            padding: 5px 10px;
            border-radius: 4px;
            white-space: nowrap;
            z-index: 1000;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
        }
        .copy-message {
            display: none;
            background-color: #d1e7dd;
            color: #0f5132;
            padding: 10px;
            border-radius: 5px;
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
        .action-icons i {
            font-size: 24px;
            cursor: pointer;
            margin-right: 10px;
            color: #333;
        }
        .short-column {
            width: 10%;
        }
        .card-title {
            font-weight: 400;
            font-size: 1.6rem;
            color: #000;
            margin-bottom: 0.5rem;
        }
        .card-text {
            font-size: 1.1rem;
            line-height: 1.8rem;
            color: #666;
            margin-bottom: 1rem;
            letter-spacing: 0.5px;
        }
        .card-body .user-info {
            color: #333;
            margin-bottom: 0.2rem;
            line-height: 1.6rem;
        }
.hidden {
    display: none;
}


/* Couleurs dynamiques selon les jours restants */
.progress-bar.green { background-color: #8BC34A !important; }  /* ✅ Vert */
.progress-bar.orange { background-color: #FFC107 !important; } /* ✅ Orange */
.progress-bar.red { background-color: #FF5722 !important; }    /* ✅ Rouge */


input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
}
input[type="number"] {
    -moz-appearance: textfield;
}
.form-group {
    margin-bottom: 15px;
}

.form-group label {
    color: #333;
    display: block;
    margin-bottom: 5px;
}

.form-control {
    width: 50%;
    padding: 10px;
    font-size: 16px;
    border: 1px solid #8f97c4;
    border-radius: 5px;
    transition: border 0.3s ease-in-out;
}


/* Effet focus */
.form-control:focus {
    border-color: #8f97c4; /* Bleu */
    outline: none;
    box-shadow: 0 0 5px rgba(143, 151, 196, 0.5);
}

  .navbar .btn-outline-dark {
    margin-right: 12px;
  }
/* Réduction et centrage des champs de formulaire */
#add-property-form .form-group {
  max-width: 500px;
  margin-bottom: 20px;
}


/* Appliquer la même largeur aux inputs et textarea */
#add-property-form .form-control {
  width: 100%;
}
#add-property-form {
  padding-left: 20px;
}

/* Centrer le bouton de soumission et le rendre plus petit */
#add-property-form button[type="submit"] {
  width: 100%; /* Même largeur que les champs */
  max-width: 500px; /* Aligné sur la largeur max des .form-group */
  margin: 30px 0 0 0; /* Supprime le centrage automatique */
  padding: 10px;
  display: block;
}


/* Barre de progression des images (même largeur que input) */
#add-property-form progress {
  display: block;
  width: 100%;
  height: 6px;
  margin-top: 8px;
}


        @media (max-width: 767px) {
            .container-fluid {
                padding-left: 0;
                padding-right: 0;
            }
            .container {
                padding-left: 15px;
                padding-right: 15px;
            }
            .row {
                flex-direction: column;
                align-items: center;
            }
  #add-property-form .form-group {
    max-width: 100%;
    padding: 0 10px;
  }

  #add-property-form button[type="submit"] {
    width: 100%;
  }
            .main-section {
                margin-left: 0;
                margin-right: 0;
                margin-top: 0;
                width: 100%;
                border-radius: 0;
                box-shadow: none;
                min-height: 300px;
                overflow-x: auto;
                padding-left: 0;
                padding-right: 0;
            }
            .sidebar {
                display: none;
            }
            .sidebar-mobile-links {
                display: block !important;
                margin-top: 10px;
            }
            .mobile-margin {
                margin-top: 30px;
            }
            table {
                width: 100%;
                table-layout: auto;
            }
            th, td {
                white-space: nowrap;
                padding: 8px;
                text-align: left;
            }
            .table tbody tr {
                height: var(--dashboard-table-row-height);
            }
            .table-responsive {
                display: block;
                width: 100%;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            #landing .form-group {
                width: 100%;
                padding: 5px;
            }
            #landing .form-control {
                width: 100%;
                padding: 10px;
                font-size: 16px;
            }
            #landing button.btn-custom {
                width: 100%;
                padding: 10px;
                font-size: 18px;
            }
            .card-title {
                font-weight: 400;
                font-size: 1.4rem;
                color: #000;
                margin-bottom: 0.5rem;
            }
            .card-text {
                font-size: 1.1rem;
                line-height: 1.8rem;
                color: #666;
                margin-bottom: 1rem;
                letter-spacing: 0.5px;
            }
            .card-body .user-info {
                color: #333;
                margin-bottom: 0.2rem;
                line-height: 1.2rem;
            }
.hidden {
    display: none;
}


progress {
    width: 100%;
    height: 10px;
    margin-top: 5px;
background-color: #d9d9d9 !important;
}
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
}
input[type="number"] {
    -moz-appearance: textfield;
}

        }
        @media (min-width: 768px) {
            .sidebar-links {
                display: none;
            }
            .card-title {
                font-size: 1.475rem;
                font-weight: 400;
                color: #000;
            }
            .card-text {
                font-size: 1rem;
                line-height: 1.6rem;
                letter-spacing: 0.4px;
            }
.hidden {
    display: none;
}

progress {
    width: 100%;
    height: 10px;
    margin-top: 5px;
}
        }
@media (max-width: 991.98px) {
      .mobile-lang-selector {
        display: flex !important;
        align-items: center;
        gap: 8px;
      }
      .desktop-lang-selector {
        display: none !important;
      }
    }
    @media (min-width: 992px) {
      .mobile-lang-selector {
        display: none !important;
      }
    }

  .ads-info {
    background-color: #e6f7ff;
    padding: 10px;
    border-radius: 5px;
    margin-bottom: 15px;
  }

  .notif-badge {
    font-size: 0.75rem;
    padding: 0.25em 0.4em;
  }

  .btn-qr {
    background-color: #007bff;
    color: #fff;
    border: none;
  }

  .btn-qr:hover {
    background-color: #0069d9;
    color: #fff;
  }

    </style>
</head>
<body id="top">
<% const isAdminUser = currentUser && currentUser.role === 'admin'; %>

<noscript>
  <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TF7HSC3N"
  height="0" width="0" style="display:none;visibility:hidden"></iframe>
</noscript>
    <main>
      <body id="top">
    <main>
<% let cleanPath = currentPath.replace(/^\/(fr|en)/, '') || '/'; %>
     <nav class="navbar navbar-expand-lg fixed-top">
  <div class="container">
    <a class="navbar-brand" href="/">
      <span>UAP Immo</span>
    </a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
      data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false"
      aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarNav">
      <!-- MENU PRINCIPAL -->
      <ul class="navbar-nav ms-lg-5 me-lg-auto">
        <li class="nav-item">
          <a class="nav-link click-scroll" href="/"><%= i18n.menu.home %></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/<%= locale %>/contact"><%= i18n.menu.contact %></a>
        </li>

        <!-- Liens supplémentaires visibles uniquement en mobile -->
        <li class="nav-item sidebar-mobile-links sidebar-links">
          <a class="nav-link click-scroll" href="#" onclick="showSection('account')"><i class="fa fa-user"></i> <%= i18n.my_profile %></a>
        </li>
        <li class="nav-item sidebar-mobile-links sidebar-links">
          <a class="nav-link click-scroll" href="#" onclick="showSection('landing')"><i class="fa fa-pencil-alt"></i> <%= i18n.add_property %></a>
        </li>
        <li class="nav-item sidebar-mobile-links sidebar-links">
          <a class="nav-link click-scroll" href="#" onclick="showSection('donnees')"><i class="fa-solid fa-chart-line"></i> <%= i18n.stats %></a>
        </li>
<% /* LIEN MOBILE REDONDANT - AVEC PASTILLE VERTE */ %>
<li class="nav-item sidebar-mobile-links sidebar-links">
  <a class="nav-link click-scroll position-relative d-inline-flex align-items-center" href="#" onclick="showSection('created-pages')">
    <i class="fa fa-house me-2"></i> 
    <%= i18n.created_pages %>
    <% if (userLandingPages && userLandingPages.length > 0) { %>
      <span class="badge rounded-pill bg-success ms-1"
            style="
              padding: 0.25em 0.6em;
              line-height: 1;
              font-size: 0.75rem;
            ">
        <%= userLandingPages.length %>
      </span>
    <% } %>
  </a>
</li>
        <li class="nav-item sidebar-mobile-links sidebar-links">
          <a class="nav-link click-scroll" href="#" onclick="showSection('orders')"><i class="fa fa-shopping-cart"></i> <%= i18n.my_orders %></a>
        </li>
        <% if (isAdminUser) { %>
        <li class="nav-item sidebar-mobile-links sidebar-links">
          <a class="nav-link click-scroll admin-nav-link" href="#" onclick="showSection('admin-users')"><i class="fa fa-users"></i> <%= i18n.admin_user_management %></a>
        </li>
        <li class="nav-item sidebar-mobile-links sidebar-links">
          <a class="nav-link click-scroll admin-nav-link" href="#" onclick="showSection('admin-properties')"><i class="fa fa-building"></i> <%= i18n.admin_property_management %></a>
        </li>
        <li class="nav-item sidebar-mobile-links sidebar-links">
          <a class="nav-link click-scroll admin-nav-link" href="#" onclick="showSection('admin-orders')"><i class="fas fa-shopping-basket"></i> <%= i18n.admin_orders_overview_title %></a>
        </li>
        <% } %>

        <!-- Connexion / Compte - version MOBILE -->
        <% if (isAuthenticated) { %>
          <li class="nav-item d-lg-none">
          <% /* NOUVEAU CODE MOBILE - PASTILLE RETIRÉE */ %>
<li class="nav-item d-lg-none">
  <a class="nav-link d-flex align-items-center gap-2" href="/<%= locale %>/user">
    <i class="bi bi-person-circle"></i>
    <%= locale === 'fr' ? 'Mon compte' : 'My Account' %>
  </a>
</li>
          </li>
          <li class="nav-item d-lg-none">
            <form action="/logout" method="POST" class="w-100">
              <button type="submit" class="nav-link btn btn-link text-start d-flex align-items-center gap-2 w-100" style="border: none; background: none;">
                <i class="bi bi-box-arrow-right"></i>
                <%= locale === 'fr' ? 'Déconnexion' : 'Logout' %>
              </button>
            </form>
          </li>
        <% } else { %>
          <li class="nav-item d-lg-none">
            <a class="nav-link d-flex align-items-center gap-2" href="/<%= locale %>/login">
              <i class="bi bi-person-fill"></i>
              <%= locale === 'fr' ? 'Connexion' : 'Login' %>
            </a>
          </li>
        <% } %>
      </ul>

      <!-- Connexion / Compte - version DESKTOP -->
      <% if (isAuthenticated) { %>
        <div class="d-none d-lg-flex align-items-center ms-auto">
          <a href="/<%= locale %>/user" class="btn btn-outline-dark rounded-pill px-3 py-1 me-2 d-flex align-items-center gap-2">
  <i class="bi bi-person-circle"></i>
  <span><%= locale === 'fr' ? 'Mon compte' : 'My Account' %></span>
</a>
          <form action="/logout" method="POST" class="d-inline">
            <button type="submit" class="btn btn-outline-dark rounded-pill px-3 py-1 d-flex align-items-center gap-2">
              <i class="bi bi-box-arrow-right"></i>
              <span><%= locale === 'fr' ? 'Déconnexion' : 'Logout' %></span>
            </button>
          </form>
        </div>
      <% } else { %>
        <div class="d-none d-lg-flex align-items-center ms-auto">
          <a href="/<%= locale %>/login" class="btn btn-outline-dark rounded-pill px-3 py-1 me-3 d-flex align-items-center gap-2">
            <i class="bi bi-person-fill"></i>
            <span><%= locale === 'fr' ? 'Connexion' : 'Login' %></span>
          </a>
        </div>
      <% } %>

      <!-- Sélecteur de langue - uniquement desktop -->
      <div class="desktop-lang-selector ms-3">
        <div class="dropdown">
          <button class="btn btn-light border rounded-pill px-3 py-1 d-flex align-items-center gap-2" type="button" data-bs-toggle="dropdown" aria-expanded="false">
            <span class="lang-flag <%= locale === 'fr' ? 'lang-fr' : 'lang-en' %>"></span>
            <i class="bi bi-chevron-down small"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end shadow">
            <% if (locale === 'fr') { %>
              <li><a class="dropdown-item d-flex align-items-center gap-2" href="/en<%= cleanPath %>"><span class="lang-flag lang-en"></span> <span>English</span></a></li>
            <% } else { %>
              <li><a class="dropdown-item d-flex align-items-center gap-2" href="/fr<%= cleanPath %>"><span class="lang-flag lang-fr"></span> <span>Français</span></a></li>
            <% } %>
          </ul>
        </div>
      </div>
    </div>
  </div>
</nav>


<section class="contact-section section-padding section-bg" id="section_5">
    <div class="container">
        <h5 class="text-black mobile-margin">
            <% if (user) { %>
                <%= i18n.welcome_user.replace('{lastName}', user.lastName).replace('{firstName}', user.firstName) %>
            <% } else { %>
                <%= i18n.welcome_guest %>
            <% } %>
        </h5>
        <div class="container-fluid">
            <div class="row mt-4 dashboard-layout">
                <div class="col-auto p-0">
                   <div class="sidebar">
  <a href="#" onclick="showSection('account')"><i class="fa fa-user"></i></a>
  <a href="#" onclick="showSection('landing')"><i class="fa fa-pencil-alt"></i></a>
  <a href="#" onclick="showSection('donnees')"><i class="fa-solid fa-chart-line"></i></a>
  <% /* NOUVEAU LIEN SIDEBAR - AVEC PASTILLE */ %>
<% /* SIDEBAR DESKTOP - AVEC PASTILLE VERTE */ %>
<a href="#" onclick="showSection('created-pages')" class="position-relative">
  <i class="fa fa-house"></i>
  <% if (userLandingPages && userLandingPages.length > 0) { %>
    <span class="position-absolute translate-middle badge rounded-pill bg-success" 
          style="
            font-size: 0.6rem; 
            padding: 0.3em 0.5em; 
            line-height: 1;
            right: 0px;
            top: 2px;
          ">
      <%= userLandingPages.length %>
      <span class="visually-hidden">nouvelles pages</span>
    </span>
  <% } %>
</a>
  <a href="#" onclick="showSection('orders')"><i class="fa fa-shopping-cart"></i></a>
  <% if (isAdminUser) { %>
  <a class="admin-sidebar-link" href="#" onclick="showSection('admin-users')" title="<%= i18n.admin_user_management %>"><i class="fa fa-users"></i></a>
  <a class="admin-sidebar-link" href="#" onclick="showSection('admin-properties')" title="<%= i18n.admin_property_management %>"><i class="fa fa-building"></i></a>
  <a class="admin-sidebar-link" href="#" onclick="showSection('admin-orders')" title="<%= i18n.admin_orders_overview_title %>"><i class="fas fa-shopping-basket"></i></a>
  <% } %>
</div>

                </div>
          <div class="col">
  <div class="main-section">
  <!-- SECTION ACCOUNT -->
<!-- SECTION ACCOUNT -->
<div id="account" class="card">
  <div class="card-body">
    <h5 class="card-title"><%= i18n.my_profile %></h5>
    <p class="card-text"><%= i18n.profile_info %></p>

    <!-- ✅ Bouton Fonctionnement directement sous l'intro -->
    <button id="toggleHelpProfile" class="btn btn-outline-dark btn-sm mb-3 d-flex align-items-center gap-2" type="button">
      <i class="bi bi-info-circle"></i>
      <span><%= i18n.menu.fonctionnement %></span>
    </button>

    <div id="helpProfileDetails" class="collapse mt-2">
      <p class="card-text"><%= i18n.help_profile_line1 %></p>
      <p class="card-text"><%= i18n.help_profile_line2 %></p>
      <p class="card-text"><%= i18n.help_profile_line3 %></p>
    </div>

    <!-- Infos utilisateur -->
    <p class="card-text user-info"><strong><%= i18n.name %> :</strong> <%= user.lastName %></p>
    <p class="card-text user-info"><strong><%= i18n.first_name %> :</strong> <%= user.firstName %></p>
    <p class="card-text user-info"><strong><%= i18n.email %> :</strong> <%= user.email %></p>
<!-- GESTION ADRESSE DE FACTURATION -->
        <hr class="my-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0 text-muted"><i class="bi bi-geo-alt-fill me-2"></i>Adresse de facturation</h6>
            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#editAddressCollapse" aria-expanded="false">
                <i class="bi bi-pencil-square"></i> <%= (user.billingAddress && user.billingAddress.street) ? 'Modifier' : 'Ajouter' %>
            </button>
        </div>

        <!-- Affichage de l'adresse (si existante) -->
        <div id="address-display" class="<%= (user.billingAddress && user.billingAddress.street) ? '' : 'd-none' %>">
            <p class="card-text user-info text-muted mb-0" id="display-street"><%= user.billingAddress ? user.billingAddress.street : '' %></p>
            <p class="card-text user-info text-muted mb-0">
                <span id="display-zip"><%= user.billingAddress ? user.billingAddress.zipCode : '' %></span> 
                <span id="display-city"><%= user.billingAddress ? user.billingAddress.city : '' %></span>
            </p>
            <p class="card-text user-info text-muted" id="display-country"><%= user.billingAddress ? user.billingAddress.country : '' %></p>
        </div>
        
        <div id="address-empty-msg" class="<%= (user.billingAddress && user.billingAddress.street) ? 'd-none' : '' %>">
            <p class="text-muted small"><em>Aucune adresse enregistrée.</em></p>
        </div>

        <!-- Formulaire d'édition (Caché par défaut) -->
       <!-- Dans views/user.ejs -->

<div class="collapse mt-3" id="editAddressCollapse">
    <div class="card card-body bg-light border-0 p-3">
        <form id="dashboard-address-form">
            
            <!-- Rue -->
            <div class="mb-3">
                <input type="text" id="dash-street" class="form-control form-control-sm" placeholder="N° et Rue" value="<%= user.billingAddress ? user.billingAddress.street : '' %>" required>
            </div>

            <!-- Code Postal (Sur sa propre ligne) -->
            <div class="mb-3">
                <input type="text" id="dash-zip" class="form-control form-control-sm" placeholder="Code Postal" value="<%= user.billingAddress ? user.billingAddress.zipCode : '' %>" required>
            </div>

            <!-- Ville (Sur sa propre ligne) -->
            <div class="mb-3">
                <input type="text" id="dash-city" class="form-control form-control-sm" placeholder="Ville" value="<%= user.billingAddress ? user.billingAddress.city : '' %>" required>
            </div>

            <!-- Pays -->
            <div class="mb-3">
                <input type="text" id="dash-country" class="form-control form-control-sm" placeholder="Pays" value="<%= user.billingAddress ? user.billingAddress.country : '' %>" required>
            </div>

            <!-- Bouton large pour faciliter le clic sur mobile -->
            <button type="submit" class="btn btn-dark btn-sm w-40 py-2" id="btn-save-addr">
                Enregistrer l'adresse
            </button>
        </form>
    </div>
</div>
        <!-- FIN GESTION ADRESSE -->
    <p class="card-text user-info d-flex align-items-center">
      <strong><%= i18n.two_factor_auth %></strong>
      <% if (!user.twoFactorEnabled) { %>
        <a href="/<%= locale %>/enable-2fa" class="btn btn-sm btn-warning ms-2"><%= i18n.enable_2fa %></a>
      <% } else { %>
        <span class="badge bg-success ms-2"><%= i18n.two_factor_enabled %></span>
      <% } %>
    </p>

  

    <hr class="my-4">

    <!-- Vos Annonces -->
    <div class="ads-info">
      <p class="card-text"><strong><%= i18n.your_ads %></strong></p>
      <% if (userLandingPages && userLandingPages.length > 0) { %>
        <p class="card-text"><%- i18n.ads_generated.replace('{count}', userLandingPages.length) %></p>
        <p class="card-text"><%- i18n.remember_to_publish %></p>
      <% } else { %>
        <p class="card-text"><%= i18n.no_ads_yet %></p>
        <a href="#" onclick="showSection('landing')" class="btn btn-sm btn-outline-dark mt-2">
          <i class="bi bi-plus-circle"></i><%= i18n.create_first_ad %>
        </a>
      <% } %>
    </div>
  </div>
</div>

<!-- ✅ FORMULAIRE AMÉLIORÉ UX - SECTION LANDING -->
<div id="landing" class="card" style="display: none;">
  <div class="card-body">
    <h5 class="card-title"><%= i18n.add_property %></h5>
    <p class="card-text"><%= i18n.property_details %></p>

    <div class="progress mb-4">
  <div class="progress-bar" role="progressbar" id="formProgress" style="width: 25%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">Étape 1 sur 4</div>
</div>

    <div id="success-message-container"></div>

    <form id="add-property-form" action="/add-property" method="POST" enctype="multipart/form-data">
      <input type="hidden" id="userId" name="userId" value="<%= user._id %>">

      <!-- Étape 1 -->
      <div class="form-step" data-step="1">
        <h6 class="mb-3"><%= i18n.step1_title %></h6>
        <div class="form-group">
          <label for="rooms"><%= i18n.rooms %>
            <i class="fa fa-question-circle ms-1 text-muted" data-bs-toggle="tooltip" title="Inclut chambres, salon, cuisine, etc."></i>
          </label>
          <input type="number" class="form-control" id="rooms" name="rooms" required>
          <small class="form-text text-muted">Inclut les chambres, salons, etc.</small>
        </div>

        <div class="form-group">
          <label for="bedrooms"><%= i18n.bedrooms %>
            <i class="fa fa-question-circle ms-1 text-muted" data-bs-toggle="tooltip" title="Nombre de chambres à coucher"></i>
          </label>
          <input type="number" class="form-control" id="bedrooms" name="bedrooms" required>
          <small class="form-text text-muted">Indiquez uniquement les chambres à coucher.</small>
        </div>

        <div class="form-group">
          <label for="surface"><%= i18n.surface %> <span style="color:red">*</span>
            <i class="fa fa-question-circle ms-1 text-muted" data-bs-toggle="tooltip" title="Surface habitable en m²"></i>
          </label>
          <input type="number" class="form-control" id="surface" name="surface" required>
          <small class="form-text text-muted">Exemple : 120</small>
        </div>

        <div class="form-group">
          <label for="price"><%= i18n.price %> <span style="color:red">*</span>
            <i class="fa fa-question-circle ms-1 text-muted" data-bs-toggle="tooltip" title="Prix affiché sur l’annonce"></i>
          </label>
          <input type="number" class="form-control" id="price" name="price" required>
          <small class="form-text text-muted">Exemple : 750000</small>
        </div>

        <div class="form-group">
          <label for="country"><%= i18n.country %> <span style="color:red">*</span>
            <i class="fa fa-question-circle ms-1 text-muted" data-bs-toggle="tooltip" title="Pays où se situe le bien"></i>
          </label>
          <input type="text" class="form-control" id="country" name="country" required>
        </div>

        <div class="form-group">
          <label for="postalCode"><%= i18n.postal_code %>
            <i class="fa fa-question-circle ms-1 text-muted" data-bs-toggle="tooltip" title="Code postal à 5 chiffres"></i>
          </label>
          <input type="text" name="postalCode" id="postalCode" class="form-control" required>
        </div>

        <div class="form-group">
          <label for="city"><%= i18n.city %> <span style="color: red;">*</span>
            <i class="fa fa-question-circle ms-1 text-muted" data-bs-toggle="tooltip" title="Ville ou commune du bien"></i>
          </label>
          <input type="text" class="form-control" id="city" name="city" required>
        </div>

        <div class="form-group">
          <label for="yearBuilt"><%= i18n.year_built %>
            <i class="fa fa-question-circle ms-1 text-muted" data-bs-toggle="tooltip" title="Année de construction du bien"></i>
          </label>
          <input type="number" class="form-control" id="yearBuilt" name="yearBuilt">
          <small class="form-text text-muted">Exemple : 1995</small>
        </div>

        <div class="form-group">
          <label for="propertyType"><%= i18n.property_type %> <span style="color:red">*</span>
            <i class="fa fa-question-circle ms-1 text-muted" data-bs-toggle="tooltip" title="Type de bien (villa, maison, appartement...)"></i>
          </label>
          <select class="form-control" id="propertyType" name="propertyType" required>
            <option value="">-- Choisir --</option>
            <option value="Propriété">Propriété</option>
            <option value="Villa">Villa</option>
            <option value="Hôtel particulier">Hôtel particulier</option>
            <option value="Appartement">Appartement</option>
            <option value="Chateau">Château</option>
            <option value="Maison">Maison</option>
          </select>
        </div>

        <button type="button" class="btn btn-primary next-step mt-3"><%= i18n.next %></button>
      </div>

      <!-- Étape 2 -->
       <div class="form-step d-none" data-step="2">
        <h6 class="mb-3"><%= i18n.equipment %></h6>
        <% const equipmentOptions = [
          { id: 'pool', label: 'Piscine' },
          { id: 'doubleGlazing', label: 'Double vitrage' },
          { id: 'wateringSystem', label: 'Arrosage automatique' },
          { id: 'barbecue', label: 'Barbecue' },
          { id: 'carShelter', label: 'Abri de voiture' },
          { id: 'parking', label: 'Parking' },
          { id: 'caretakerHouse', label: 'Maison de gardien' },
          { id: 'electricShutters', label: 'Stores électriques' },
          { id: 'outdoorLighting', label: 'Éclairage extérieur' }
        ]; %>

        <% equipmentOptions.forEach(e => { %>
          <div class="form-group">
            <label for="<%= e.id %>"><%= e.label %>
              <i class="fa fa-question-circle ms-1 text-muted" data-bs-toggle="tooltip" title="Présence ou non de cet équipement."></i>
            </label>
            <select class="form-control" id="<%= e.id %>" name="<%= e.id %>" <%= e.id === 'parking' ? 'required' : '' %>>
              <option value="false">Non</option>
              <option value="true">Oui</option>
            </select>
          </div>
        <% }); %>

        <button type="button" class="btn btn-secondary prev-step mt-3 me-2"><%= i18n.previous %></button>
        <button type="button" class="btn btn-primary next-step mt-3"><%= i18n.next %></button>
      </div>

      <!-- Étape 3 -->
       <div class="form-step d-none" data-step="3">
        <h6 class="mb-3"><%= i18n.photos_title %></h6>
        <div class="form-group">
          <label for="dpe"><%= i18n.dpe_label %> <span style="color:red">*</span>
            <i class="fa fa-question-circle ms-1 text-muted" data-bs-toggle="tooltip" title="Classe énergétique du bien (obligatoire)"></i>
          </label>
          <select class="form-control" id="dpe" name="dpe" required>
            <option value="">-- Sélectionner --</option>
            <option value="A">A - Excellent</option>
            <option value="B">B - Très bon</option>
            <option value="C">C - Bon</option>
            <option value="D">D - Moyenne</option>
            <option value="E">E - Passable</option>
            <option value="F">F - Mauvais</option>
            <option value="G">G - Très mauvais</option>
            <option value="En cours">En cours</option>
          </select>
        </div>

        <div class="form-group">
          <label for="photo1"><%= i18n.main_photo %> <span class="text-danger">*</span></label>
          <input type="file" class="form-control" id="photo1" name="photo1" accept="image/*" required onchange="handleFileUpload(this, 'progress1', 'status1')">
          <progress id="progress1" value="0" max="100" style="width: 100%; display: none;"></progress>
          <span id="status1" class="text-muted small d-block mt-1"></span>
        </div>

        <div class="form-group">
          <label for="photo2"><%= i18n.secondary_photo %> <span style="color:red">*</span></label>
          <input type="file" class="form-control" id="photo2" name="photo2" accept="image/*" required onchange="handleFileUpload(this, 'progress2', 'status2')">
          <progress id="progress2" value="0" max="100" style="width: 100%; display: none;"></progress>
          <span id="status2" class="text-muted small d-block mt-1"></span>
        </div>

        <div class="form-group">
          <label>Photos supplémentaires pour le carrousel</label>
          <div class="row">
            <% for (let i = 1; i <= 8; i++) { %>
              <div class="col-6 col-md-3 mb-3">
                <input
                  type="file"
                  class="form-control extra-photo-input"
                  id="extraPhoto<%= i %>"
                  name="extraPhotos"
                  accept="image/*">
                <img
                  id="extraPreview<%= i %>"
                  class="mt-2 border rounded d-none w-100"
                  style="height:80px; object-fit:cover;" />
              </div>

            <% } %>
          </div>
        </div>



        <div class="form-group">
          <label for="miniPhotos">Petites photos (max 3)</label>
          <input type="file" class="form-control" id="miniPhotos" name="miniPhotos" accept="image/*" multiple>
          <div id="miniPhotosPreview" class="d-flex flex-wrap gap-2 mt-2"></div>
        </div>

        <div class="form-group">
          <label for="videoUrl">Lien YouTube</label>
          <input type="url" class="form-control" id="videoUrl" name="videoUrl" placeholder="https://www.youtube.com/watch?v=...">
          <div id="mediaNotice" class="form-text text-muted mt-1">Ajoutez vos photos ou indiquez un lien vidéo plein écran.</div>
        </div>

        <button type="button" class="btn btn-secondary prev-step mt-3 me-2"><%= i18n.previous %></button>
        <button type="button" class="btn btn-primary next-step mt-3"><%= i18n.next %></button>
      </div>

      <!-- Étape 4 -->
      <div class="form-step d-none" data-step="4">
        <h6 class="mb-3"><%= i18n.description_title %></h6>
        <div class="form-group">
          <label for="description"><%= i18n.description_label %> <span style="color:red">*</span></label>
          <textarea class="form-control" id="description" name="description" rows="5" maxlength="820" required></textarea>
          <small id="charCount">0/820 <%= i18n.characters %></small>
        </div>
        <div class="row mt-3">
          <div class="col-md-4">
            <label for="contactFirstName">Prénom</label>
            <input type="text" class="form-control" id="contactFirstName" name="contactFirstName">
          </div>
          <div class="col-md-4">
            <label for="contactLastName">Nom</label>
            <input type="text" class="form-control" id="contactLastName" name="contactLastName">
          </div>
          <div class="col-md-4">
            <label for="contactPhone">Téléphone</label>
            <input type="text" class="form-control" id="contactPhone" name="contactPhone">
          </div>
        </div>
        <div class="form-group mt-3">
          <label class="d-block"><%= i18n.language_label %> <span style="color:red">*</span></label>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="language" id="lang-fr" value="fr" required>
            <label class="form-check-label d-flex align-items-center" for="lang-fr" data-bs-toggle="tooltip" title="la page sera générée dans la langue choisi, veillez à ce que les informations indiquer dans le formulaire soit bien dans la langue defini">
              <span class="lang-flag lang-fr me-1"></span>FR
            </label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="language" id="lang-en" value="en" required>
            <label class="form-check-label d-flex align-items-center" for="lang-en" data-bs-toggle="tooltip" title="la page sera générée dans la langue choisi, veillez à ce que les informations indiquer dans le formulaire soit bien dans la langue defini">
              <span class="lang-flag lang-en me-1"></span>EN
            </label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="language" id="lang-es" value="es" required>
            <label class="form-check-label d-flex align-items-center" for="lang-es" data-bs-toggle="tooltip" title="la page sera générée dans la langue choisi, veillez à ce que les informations indiquer dans le formulaire soit bien dans la langue defini">
              <span class="lang-flag lang-es me-1"></span>ES
            </label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="language" id="lang-pt" value="pt" required>
            <label class="form-check-label d-flex align-items-center" for="lang-pt" data-bs-toggle="tooltip" title="la page sera générée dans la langue choisi, veillez à ce que les informations indiquer dans le formulaire soit bien dans la langue defini">
              <span class="lang-flag lang-pt me-1"></span>PT
            </label>
          </div>
        </div>
        <button type="button" class="btn btn-secondary prev-step mt-3 me-2"><%= i18n.previous %></button>
        <button type="submit" class="btn btn-dark py-2 mt-3">
          <i class="fa fa-check-circle me-2"></i><%= i18n.create_ad %>
        </button>
      </div>

      <div id="generatedLink" class="mt-3"></div>
    </form>

<script>
  let currentStep = 1;

  function showStep(step) {
    // 1. Masquer toutes les étapes
    document.querySelectorAll('.form-step').forEach(div => {
      div.classList.add('d-none');
      div.style.opacity = 0;
    });

    // 2. Afficher l'étape courante
    const stepEl = document.querySelector(`.form-step[data-step='${step}']`);
    
    if(stepEl) {
        stepEl.classList.remove('d-none');
        
        // Petit délai pour permettre la transition CSS d'opacité (si vous en avez une)
        setTimeout(() => { stepEl.style.opacity = 1; }, 50);

        // Mise à jour de la barre de progression
        const progressBar = document.getElementById('formProgress');
if (progressBar) {
  progressBar.style.width = `${step * 25}%`;
  // Assurez-vous que ${step} est bien présent au milieu de la phrase
  progressBar.innerText = `Étape ${step} sur 4`; 
}

        // --- CORRECTION SCROLL ---
        // Remonte automatiquement en haut du formulaire
        // On cible le conteneur du formulaire
        const cardContainer = document.querySelector('#landing .card-body');
        if(cardContainer) {
            // On calcule la position absolue moins 100px pour laisser de la place à la navbar fixe
            const y = cardContainer.getBoundingClientRect().top + window.pageYOffset - 120;
            window.scrollTo({top: y, behavior: 'smooth'});
        }
    }
  }

  // Gestionnaire bouton SUIVANT avec validation
  document.querySelectorAll('.next-step').forEach(btn => {
    btn.addEventListener('click', () => {
      // Récupérer les champs de l'étape actuelle
      const currentStepDiv = document.querySelector(`.form-step[data-step='${currentStep}']`);
      const inputs = currentStepDiv.querySelectorAll('input, select, textarea');
      let valid = true;

      // Vérifier la validité HTML5 (required, type, etc.)
      for (let field of inputs) {
        if (!field.checkValidity()) {
          field.reportValidity(); // Affiche le message d'erreur natif du navigateur
          valid = false;
          return; // Arrête la boucle à la première erreur
        }
      }

      // Si tout est valide, on passe à l'étape suivante
      if (valid) {
        currentStep++;
        showStep(currentStep);
      }
    });
  });

  // Gestionnaire bouton PRÉCÉDENT
  document.querySelectorAll('.prev-step').forEach(btn => {
    btn.addEventListener('click', () => {
      currentStep--;
      showStep(currentStep);
    });
  });

  // Validation spécifique lors de la soumission finale
  document.querySelector('#add-property-form')?.addEventListener('submit', function (e) {
    const postalCode = document.getElementById('postalCode')?.value;
    const postalCodePattern = /^\d{5}$/;
    
    // Double vérification du code postal au cas où
    if (postalCode && !postalCodePattern.test(postalCode)) {
      e.preventDefault();
      alert('Le code postal doit contenir exactement 5 chiffres.');
    }
  });

  // Initialisation des tooltips Bootstrap
  const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
  tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));

  // Lancer l'étape 1 au chargement
  showStep(currentStep);
</script>
  </div>
</div>



                        <!-- Section Données -->
                     <div id="donnees" class="card" style="display: none;">
  <div class="card-body">
    <h5 class="card-title"><%= i18n.stats %></h5>
  <p class="card-text mb-3"><%= i18n.stats_info %></p>

<!-- Bouton toggle -->
  <button id="toggleDetailsBtn" class="btn btn-outline-dark btn-sm mb-3 d-flex align-items-center gap-2" type="button">
  <i class="bi bi-info-circle"></i>
  <span><%= i18n.show_column_details %></span>
  </button>

<!-- Section masquée -->
<div id="statsDetails" class="mb-3">
  <p class="card-text mb-1">Page : titre ou lien de l’annonce concernée.</p>
  <p class="card-text mb-1">Vues : nombre total de fois où la page a été affichée, toutes visites confondues.</p>
  <p class="card-text mb-1">Utilisateurs : nombre de visiteurs uniques (comptés une seule fois chacun).</p>
  <p class="card-text mb-1">Scrolls : nombre de fois où les visiteurs ont fait défiler la page (indicateur d’intérêt).</p>
  <p class="card-text mb-1">Source : origine de la visite (ex. : lien direct, moteur de recherche, réseaux sociaux).</p>
  <p class="card-text mb-1">Géolocalisation : localisation géographique estimée du visiteur (ville ou pays).</p>
  <p class="card-text mb-1">Appareil : type d’appareil utilisé pour consulter la page (ordinateur, mobile, tablette).</p>
  <p class="card-text mb-1">OS : système d’exploitation utilisé (Windows, macOS, Android, iOS, etc.).</p>
  <p class="card-text mb-1">Navigateur : logiciel de navigation utilisé (Chrome, Safari, Firefox, etc.).</p>
  <p class="card-text mb-1">Langue : langue du navigateur ou de l’appareil de l’utilisateur.</p>
</div>


    <form id="statsFilter" class="mb-3">
  <div class="row g-2 align-items-end">
    <div class="col-sm-6 col-md-3">
      <label for="startDate" class="form-label"><%= i18n.start_date %></label>
      <input type="date" id="startDate" name="startDate" class="form-control" required>
    </div>
    <div class="col-sm-6 col-md-3">
      <label for="endDate" class="form-label"><%= i18n.end_date %></label>
      <input type="date" id="endDate" name="endDate" class="form-control" required>
    </div>
    <div class="col-12 col-md-3">
      <button type="submit" class="btn btn-dark w-100 mt-3 mt-md-0"><%= i18n.filter_stats %></button>
    </div>
  </div>
</form>



   <div class="table-responsive">
      <table class="table table-striped">
 <thead class="table-dark">
  <tr>
    <th>
      <span data-bs-toggle="tooltip" title="Lien de l'annonce"><%= i18n.table_page %></span>
    </th>
    <th>
      <span data-bs-toggle="tooltip" title="Nombre total de vues"><%= i18n.table_views %></span>
    </th>
    <th>
      <span data-bs-toggle="tooltip" title="Nombre d'utilisateurs uniques"><%= i18n.table_users %></span>
    </th>
    <th>
      <span data-bs-toggle="tooltip" title="Nombre de scrolls détectés"><%= i18n.table_scrolls %></span>
    </th>
    <th>
      <span data-bs-toggle="tooltip" title="Source de trafic (ex : Google, Facebook…)"><%= i18n.table_source %></span>
    </th>
    <th>
      <span data-bs-toggle="tooltip" title="Pays, région et ville"><%= i18n.table_location %></span>
    </th>
    <th>
      <span data-bs-toggle="tooltip" title="Type d'appareil (mobile, desktop…)"><%= i18n.table_device %></span>
    </th>
    <th>
      <span data-bs-toggle="tooltip" title="Système d'exploitation"><%= i18n.table_os %></span>
    </th>
    <th>
      <span data-bs-toggle="tooltip" title="Navigateur utilisé"><%= i18n.table_browser %></span>
    </th>
    <th>
      <span data-bs-toggle="tooltip" title="Langue du navigateur"><%= i18n.table_language %></span>
    </th>
  </tr>
</thead>

 <tbody id="stats-table-body">
  <% if (stats && stats.length > 0) { %>
    <% stats.forEach(stat => { %>
      <tr>
        <td><%= stat.page %></td>
        <td><%= stat.views %></td>
        <td><%= stat.users %></td>
        <td><%= stat.scrolls %></td>
        <td><%= stat.geo.country %></td>
        <td><%= stat.device %></td>
        <td><%= stat.os %></td>
        <td><%= stat.browser %></td>
        <td><%= stat.language %></td>
        <td><%= stat.source %></td>
      </tr>
    <% }); %>
  <% } else { %>
    <tr><td colspan="10"><%= i18n.no_stats_available %></td></tr>
  <% } %>
</tbody>
</table>
    </div>
  </div>
</div>


<!-- ... tout le code HTML ci-dessus reste inchangé ... -->

<!-- Section Mes Commandes (design harmonisé) -->
<div id="orders" class="card" style="display: none;">
  <div class="card-body">
   <h5 class="card-title"><%= i18n.my_orders %></h5>
<p class="card-text"><%= i18n.orders_info %></p>


    <div class="table-responsive">
      <table class="table table-striped">
       <thead class="table-dark">
  <tr>
    <th>
      <span data-bs-toggle="tooltip" title="Numéro de votre commande">
        <%= i18n.orders_table_order %>
      </span>
    </th>
    <th>
      <span data-bs-toggle="tooltip" title="Date de votre commande">
        <%= i18n.orders_table_date %>
      </span>
    </th>
  
    <th>
      <span data-bs-toggle="tooltip" title="Statut de la commande (payée ou en attente)">
        <%= i18n.orders_table_status %>
      </span>
    </th>

<th>Paiement</th>

    <th>
      <span data-bs-toggle="tooltip" title="Nombre de jours de diffusion restants (max 90 jours)">
        <%= i18n.orders_table_days_left %>
      </span>
    </th>
    <th>
      <span data-bs-toggle="tooltip" title="Fin de la diffusion publicitaire (90 jours après l'achat)">
        <%= i18n.orders_table_expiration %>
      </span>
    </th>
    <th>
      <span data-bs-toggle="tooltip" title="Copier l’URL, voir la page, télécharger la facture">
        <%= i18n.orders_table_actions %>
      </span>
    </th>
  </tr>
</thead>

        <tbody id="orders-list"></tbody>
      </table>
    </div>

    <div id="no-orders-message" style="display: none;" class="text-center">
      <p><%= i18n.no_orders_found %></p>
    </div>
  </div>
</div>

<% if (isAdminUser) { %>
<div id="admin-users" class="card" style="display: none;">
  <div class="card-body">
    <h5 class="card-title"><%= i18n.admin_user_management %></h5>
    <div class="d-flex align-items-center gap-2 text-muted mb-3">
      <i class="fas fa-shopping-basket"></i>
      <span><%= i18n.admin_orders_section_hint %></span>
    </div>
    <p class="card-text"><%= i18n.admin_user_management_description %></p>

    <div class="table-responsive">
      <table class="table table-striped">
        <thead class="table-dark">
          <tr>
            <th><%= i18n.admin_table_role %></th>
            <th><%= i18n.admin_table_first_name %></th>
            <th><%= i18n.admin_table_last_name %></th>
            <th><%= i18n.admin_table_email %></th>
            <th><%= i18n.admin_table_two_factor %></th>
            <th><%= i18n.admin_table_registered_at %></th>
            <th class="text-center">
              <i class="fas fa-shopping-basket" aria-hidden="true"></i>
              <span class="visually-hidden"><%= i18n.admin_table_orders %></span>
            </th>
          </tr>
        </thead>
        <tbody>
          <% if (adminUsers && adminUsers.length > 0) { %>
            <% adminUsers.forEach(function(adminUser) { %>
              <tr>
                <td><span class="badge bg-dark text-uppercase"><%= adminUser.role %></span></td>
                <td><%= adminUser.firstName || '-' %></td>
                <td><%= adminUser.lastName || '-' %></td>
                <td><%= adminUser.email || '-' %></td>
                <td>
                  <% if (adminUser.twoFactorEnabled) { %>
                    <span class="badge bg-success"><%= i18n.admin_users_2fa_enabled %></span>
                  <% } else { %>
                    <span class="badge bg-secondary"><%= i18n.admin_users_2fa_disabled %></span>
                  <% } %>
                </td>
                <td><%= adminUser.createdAt ? new Date(adminUser.createdAt).toLocaleString(locale === 'en' ? 'en-GB' : 'fr-FR') : '-' %></td>
                <td class="text-center">
                  <a href="/<%= locale %>/admin/orders/<%= adminUser._id %>" class="text-decoration-none admin-orders-link" title="<%= i18n.admin_table_view_orders %>">
                    <i class="fas fa-shopping-basket"></i>
                  </a>
                </td>
              </tr>
            <% }); %>
          <% } else { %>
            <tr>
              <td colspan="7" class="text-center"><%= i18n.admin_no_users_found %></td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div id="admin-properties" class="card" style="display: none;">
  <div class="card-body">
    <h5 class="card-title"><%= i18n.admin_property_management %></h5>
    <p class="card-text"><%= i18n.admin_property_management_description %></p>

    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead class="table-dark">
          <tr>
            <th>ID Page</th>
            <th>ID User</th>
            <th><%= i18n.created_type %></th>
            <th><%= i18n.created_rooms %></th>
            <th><%= i18n.created_bedrooms %></th>
            <th><%= i18n.created_surface %></th>
            <th><%= i18n.created_price %></th>
            <th><%= i18n.created_country %></th>
            <th><%= i18n.created_city %></th>
            <th><%= i18n.created_postal_code %></th>
            <th><%= i18n.created_year %></th>
            <th><%= i18n.created_dpe %></th>
            <th><%= i18n.created_language %></th>
            <th><%= i18n.created_pool %></th>
            <th><%= i18n.created_double_glazing %></th>
            <th><%= i18n.created_watering %></th>
            <th><%= i18n.created_barbecue %></th>
            <th><%= i18n.created_car_shelter %></th>
            <th><%= i18n.created_parking %></th>
            <th><%= i18n.created_caretaker %></th>
            <th><%= i18n.created_electric_shutters %></th>
            <th><%= i18n.created_outdoor_lighting %></th>
            <th><%= i18n.created_main_photo %></th>
            <th><%= i18n.created_secondary_photo %></th>
            <th><%= i18n.created_extra_photos %></th>
            <th><%= i18n.created_mini_photos %></th>
            <th><%= i18n.created_video_url %></th>
            <th><%= i18n.created_contact %></th>
            <th><%= i18n.created_phone %></th>
            <th><%= i18n.created_description %></th>
            <th><%= i18n.created_actions %></th>
          </tr>
        </thead>
        <tbody id="admin-properties-list">
          <% if (adminProperties && adminProperties.length > 0) { %>
            <% adminProperties.forEach(function(property) { %>
              <% const photos = Array.isArray(property.photos) ? property.photos : []; %>
              <% const mainPhotos = photos.slice(0, 2); %>
              <% const extraPhotos = photos.slice(2, 10).filter(Boolean); %>
              <% const miniPhotos = photos.slice(10, 13).filter(Boolean); %>
              <% const descriptionText = property.description || ''; %>
              <% const truncatedDescription = descriptionText && descriptionText.length > 8 ? descriptionText.substring(0, 8) + '...' : descriptionText; %>
              <tr>
                <td><%= property._id %></td>
                <td><%= property.userId %></td>
                <td><%= property.propertyType || 'NC' %></td>
                <td><%= property.rooms ?? 'NC' %></td>
                <td><%= property.bedrooms ?? 'NC' %></td>
                <td><%= property.surface ?? 'NC' %></td>
                <td><%= typeof property.price === 'number' ? property.price.toLocaleString(locale === 'en' ? 'en-US' : 'fr-FR') : (property.price || 'NC') %></td>
                <td><%= property.country || 'NC' %></td>
                <td><%= property.city || 'NC' %></td>
                <td><%= property.postalCode || 'NC' %></td>
                <td><%= property.yearBuilt || 'NC' %></td>
                <td><%= property.dpe || 'NC' %></td>
                <td><%= property.language ? property.language.toUpperCase() : 'NC' %></td>
                <td><%= property.pool ? i18n.yes : (property.pool === false ? i18n.no : 'NC') %></td>
                <td><%= property.doubleGlazing ? i18n.yes : (property.doubleGlazing === false ? i18n.no : 'NC') %></td>
                <td><%= property.wateringSystem ? i18n.yes : (property.wateringSystem === false ? i18n.no : 'NC') %></td>
                <td><%= property.barbecue ? i18n.yes : (property.barbecue === false ? i18n.no : 'NC') %></td>
                <td><%= property.carShelter ? i18n.yes : (property.carShelter === false ? i18n.no : 'NC') %></td>
                <td><%= property.parking ? i18n.yes : (property.parking === false ? i18n.no : 'NC') %></td>
                <td><%= property.caretakerHouse ? i18n.yes : (property.caretakerHouse === false ? i18n.no : 'NC') %></td>
                <td><%= property.electricShutters ? i18n.yes : (property.electricShutters === false ? i18n.no : 'NC') %></td>
                <td><%= property.outdoorLighting ? i18n.yes : (property.outdoorLighting === false ? i18n.no : 'NC') %></td>
                <td><%= mainPhotos[0] ? i18n.yes : i18n.no %></td>
                <td><%= mainPhotos[1] ? i18n.yes : i18n.no %></td>
                <td><%= extraPhotos.length %></td>
                <td><%= miniPhotos.length %></td>
                <td>
                  <% if (property.videoUrl) { %>
                    <a href="<%= property.videoUrl %>" target="_blank" class="text-decoration-underline">URL</a>
                  <% } else { %>
                    NC
                  <% } %>
                </td>
                <td><%= [property.contactFirstName, property.contactLastName].filter(Boolean).join(' ') || 'NC' %></td>
                <td><%= property.contactPhone || 'NC' %></td>
                <td>
    <% if (descriptionText) { %>
        <span 
            style="cursor: copy;" 
            title="Double-cliquez pour copier tout le texte"
            data-full="<%= descriptionText.replace(/"/g, '&quot;') %>" 
            ondblclick="copyAdminDescription(this)">
            <%= truncatedDescription %>
        </span>
    <% } else { %>
        NC
    <% } %>
</td>
               <td class="text-nowrap">
<div class="d-flex flex-nowrap gap-2">
<% if (property.url) { %>
<a href="<%= property.url %>" target="_blank" class="btn btn-sm btn-outline-dark" title="Ouvrir la page">
<i class="bi bi-box-arrow-up-right"></i>
</a>
<% } %>
<% if (property.photos && property.photos.length > 0) { %>
<a href="/admin/download-photos/<%= property._id %>" class="btn btn-sm btn-primary" title="Télécharger toutes les photos (ZIP)">
<i class="bi bi-file-earmark-zip"></i>
</a>
<% } %>
<a href="/<%= locale %>/property/edit/<%= property._id %>" class="btn btn-sm btn-success" title="Modifier">
<i class="bi bi-pencil-square"></i>
</a>
</div>
</td>
</tr>
            <% }); %>
          <% } else { %>
            <tr>
              <td colspan="31" class="text-center"><%= i18n.admin_no_properties_found %></td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div id="admin-orders" class="card" style="display: none;">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-start mb-3">
      <div>
        <h5 class="card-title"><%= i18n.admin_orders_overview_title %></h5>
        <p class="card-text text-muted mb-0"><%= i18n.admin_orders_overview_description %></p>
      </div>
      <span class="badge bg-dark rounded-pill align-self-center"><%= adminOrders && adminOrders.length ? adminOrders.length : 0 %></span>
    </div>

    <% if (adminOrders && adminOrders.length > 0) { %>
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-dark">
      <tr>
        <th scope="col"><%= i18n.admin_orders_table_order_id %></th>
        <th scope="col"><%= i18n.admin_orders_table_date %></th>
        
        <!-- COLONNE MODIFIÉE -->
        <th scope="col">Type de paiement</th>
        
        <th scope="col"><%= i18n.admin_orders_table_property_id %></th>
        <th scope="col"><%= i18n.admin_orders_amount %></th>
        <th scope="col"><%= i18n.admin_orders_table_currency %></th>
        <th scope="col"><%= i18n.admin_orders_status %></th>
        <th scope="col"><%= i18n.admin_orders_table_user_id %></th>
        <th scope="col"><%= i18n.admin_orders_table_user_name %></th>
        <th scope="col" class="text-center"><%= i18n.admin_orders_table_invoice %></th>
      </tr>
    </thead>
    <tbody>
      <% adminOrders.forEach(function(order) { %>
        <% const populatedUser = (order.userId && typeof order.userId === 'object' && order.userId._id) ? order.userId : null; %>
        <% const userIdentifier = populatedUser ? populatedUser._id : order.userId; %>
        <% const userIdDisplay = userIdentifier ? userIdentifier.toString() : '-'; %>
        <% const fullNameParts = []; %>
        <% if (populatedUser && populatedUser.firstName) { fullNameParts.push(populatedUser.firstName); } %>
        <% if (populatedUser && populatedUser.lastName) { fullNameParts.push(populatedUser.lastName); } %>
        <% const fullName = fullNameParts.join(' '); %>
        <% const formattedAmount = typeof order.amount === 'number' ? order.amount.toLocaleString(locale === 'en' ? 'en-GB' : 'fr-FR') : '-'; %>
        <% const paymentDate = order.paidAt || order.createdAt; %>
        <% const propertyIdDisplay = order.propertyId ? order.propertyId.toString() : '-'; %>
        <% const isPaid = order.status === 'paid'; %>
      <tr>
        <td><%= order.orderId || order._id %></td>
        <td><%= paymentDate ? new Date(paymentDate).toLocaleDateString('fr-FR') : '-' %></td>
        
        <!-- ✅ AFFICHAGE AVEC BADGES & ICONES -->
        <td>
          <% if (order.btcPayInvoiceId) { %>
            <span class="badge bg-warning text-dark">
                <i class="bi bi-currency-bitcoin"></i> Bitcoin
            </span>
          <% } else { %>
            <span class="badge bg-primary">
                <i class="bi bi-paypal"></i> PayPal
            </span>
          <% } %>
        </td>
        <!-- FIN MODIFICATION -->

        <td><%= propertyIdDisplay %></td>
        <td><%= formattedAmount %></td>
        <td><%= (order.currency || 'EUR').toUpperCase() %></td>
        <td>
          <span class="badge <%= isPaid ? 'bg-success' : 'bg-warning text-dark' %>">
            <%= isPaid ? i18n.admin_orders_status_paid : i18n.admin_orders_status_pending %>
          </span>
        </td>
        <td><%= userIdDisplay %></td>
        <td><%= fullName || (populatedUser && populatedUser.email ? populatedUser.email : '-') %></td>
        <td class="text-center">
          <% if (isPaid) { %>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="downloadInvoice('<%= order._id %>')" title="<%= i18n.admin_orders_invoice_download %>">
              <i class="bi bi-file-earmark-text"></i>
            </button>
          <% } else { %>
            <button type="button" class="btn btn-sm btn-outline-secondary disabled" title="<%= i18n.admin_orders_invoice_unavailable %>">
              <i class="bi bi-file-earmark-text"></i>
            </button>
          <% } %>
        </td>
      </tr>
      <% }); %>
    </tbody>
        </table>
      </div>
    <% } else { %>
      <div class="alert alert-info mb-0" role="alert"><%= i18n.admin_orders_overview_empty %></div>
    <% } %>
  </div>
</div>
<% } %>

<!-- Spinner de chargement pour statistiques -->
<div id="stats-loading" class="text-center my-3" style="display: none;">
  <div class="spinner-border text-secondary" role="status">
    <span class="visually-hidden"><%= i18n.loading %></span>
  </div>
  <p class="mt-2"><%= i18n.loading_stats %></p>
</div>

<!-- SECTION CREATED PAGES -->
 <div id="created-pages" class="card" style="display: none;">
  <div class="card-body">
    <h5 class="card-title"><%= i18n.created_pages %></h5>
    <p class="card-text"><%= i18n.created_pages_info %></p>

    <div class="table-responsive">
      <table class="table table-striped">
        <thead class="table-dark">
          <tr>
            <th><%= i18n.created_id %></th>
            <th><%= i18n.created_type %></th>
            <th><%= i18n.created_rooms %></th>
            <th><%= i18n.created_bedrooms %></th>
            <th><%= i18n.created_surface %></th>
            <th><%= i18n.created_price %></th>
            <th><%= i18n.created_country %></th>
            <th><%= i18n.created_city %></th>
            <th><%= i18n.created_postal_code %></th>
            <th><%= i18n.created_year %></th>
            <th><%= i18n.created_dpe %></th>
            <th><%= i18n.created_language %></th>
            <th><%= i18n.created_pool %></th>
            <th><%= i18n.created_double_glazing %></th>
            <th><%= i18n.created_watering %></th>
            <th><%= i18n.created_barbecue %></th>
            <th><%= i18n.created_car_shelter %></th>
            <th><%= i18n.created_parking %></th>
            <th><%= i18n.created_caretaker %></th>
            <th><%= i18n.created_electric_shutters %></th>
            <th><%= i18n.created_outdoor_lighting %></th>
            <th><%= i18n.created_main_photo %></th>
            <th><%= i18n.created_secondary_photo %></th>
            <th><%= i18n.created_extra_photos %></th>
            <th><%= i18n.created_mini_photos %></th>
            <th><%= i18n.created_video_url %></th>
            <th><%= i18n.created_contact %></th>
<th><%= i18n.created_phone %></th>
<th><%= i18n.created_description %></th>
<th class="text-nowrap"><%= i18n.created_actions %></th>
</tr>
</thead>

        <tbody id="properties-list"></tbody>
      </table>
    </div>

    <div id="no-properties-message" class="text-center" style="display: none;">
      <p><%= i18n.no_properties_message %></p>
    </div>
  </div>
</div>


<!-- Toast de confirmation -->
<div id="toast-confirm" class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999; display: none;">
  <div class="toast align-items-center text-white bg-success border-0 show" role="alert">
    <div class="d-flex">
      <div class="toast-body">
        🎉 <%= i18n.redirect_payment %>
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="document.getElementById('toast-confirm').style.display='none';"></button>
    </div>
 
          </div>
 </div>
        </div> <!-- Fin de main-section -->
             
        </div>
 </div>
 </div>
    </div>
</section>
</main>
<footer class="site-footer section-padding">
  <div class="container">
    <div class="row">
      <div class="col-lg-3 col-12 mb-4 pb-2">
        <a class="navbar-brand mb-2" href="/<%= locale %>">
          <span>UAP Immo</span>
        </a>
      </div>
      <div class="col-lg-3 col-md-4 col-6">
        <h6 class="site-footer-title mb-3"><%= i18n.footer.information_title %></h6>
        <ul class="site-footer-links">
          <li class="site-footer-link-item"><a href="/<%= locale %>" class="site-footer-link"><%= i18n.menu.home %></a></li>
          <li class="site-footer-link-item"><a href="/<%= locale %>/register" class="site-footer-link"><%= i18n.footer.create_account %></a></li>
        </ul>
      </div>
      <div class="col-lg-3 col-md-4 col-6">
        <h6 class="site-footer-title mb-3"><%= i18n.footer.access_title %></h6>
        <ul class="site-footer-links">
          <li class="site-footer-link-item"><a href="/<%= locale %>/contact" class="site-footer-link"><%= i18n.menu.contact %></a></li>
        </ul>
      </div>
      <div class="col-lg-3 col-md-4 col-12 mt-4 mt-lg-0 ms-auto">
        <div class="dropdown">
          <button class="btn btn-light border rounded-pill px-3 py-1 d-flex align-items-center gap-2" type="button" data-bs-toggle="dropdown" aria-expanded="false">
            <span class="lang-flag <%= locale === 'fr' ? 'lang-fr' : 'lang-en' %>"></span>
            <i class="bi bi-chevron-down small"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end shadow">
            <% if (locale === 'fr') { %>
              <li><a class="dropdown-item d-flex align-items-center gap-2" href="/en<%= cleanPath %>"><span class="lang-flag lang-en"></span> <span>English</span></a></li>
            <% } else { %>
              <li><a class="dropdown-item d-flex align-items-center gap-2" href="/fr<%= cleanPath %>"><span class="lang-flag lang-fr"></span> <span>Français</span></a></li>
            <% } %>
          </ul>
        </div>
      </div>
    </div>
    <p class="copyright-text mt-lg-5 mt-4">Copyright © 2025 UAP Company. <%= i18n.footer && i18n.footer.all_rights ? i18n.footer.all_rights : 'Tous droits réservés.' %>
</p>
  </div>
</footer>
<div class="copy-message" id="copyMessage"><%= i18n.copy_success_message %></div>
<!-- JavaScript -->
<script src="/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-U1DAWAznBHeqEIlVSCgzq+c9gqGAJn5c/t99JyeKa9xxaYpSvHU5awsuZVVFIhvj" crossorigin="anonymous"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const navbarCollapse = document.getElementById('navbarNav');

    document.querySelectorAll('.navbar-nav .nav-link').forEach(function (link) {
      link.addEventListener('click', function () {
        if (navbarCollapse.classList.contains('show')) {
          // Ferme le menu (collapse Bootstrap 5)
          new bootstrap.Collapse(navbarCollapse).hide();
        }
      });
    });
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    function setupToggleButton(btnId, targetId, showText, hideText) {
      const btn = document.getElementById(btnId);
      const target = document.getElementById(targetId);

      if (!btn || !target) return;

      btn.addEventListener("click", function () {
        const isVisible = target.classList.contains("show");
        target.classList.toggle("show");
        btn.querySelector("span").textContent = isVisible ? showText : hideText;
      });
    }

    // Bouton de la section Mon Profil
    setupToggleButton(
      "toggleHelpProfile",
      "helpProfileDetails",
      "<%= i18n.menu.fonctionnement %>",
      "<%= i18n.toggle_help_hide %>"
    );

    // ✅ Ajoute cet appel pour le bouton "Voir les détails des colonnes"
    setupToggleButton(
      "toggleDetailsBtn",
      "statsDetails",
      "<%= i18n.show_column_details %>",
      "<%= i18n.hide_details %>"
    );
  });
</script>

<script>
function showSection(sectionId) {
    const sections = ['account', 'landing', 'donnees', 'created-pages', 'orders', 'reset-password'];
    if (document.getElementById('admin-users')) {
        sections.push('admin-users');
    }
    if (document.getElementById('admin-properties')) {
        sections.push('admin-properties');
    }
    if (document.getElementById('admin-orders')) {
        sections.push('admin-orders');
    }

    sections.forEach(id => {
        const sectionElement = document.getElementById(id);
        if (sectionElement) {
            sectionElement.style.display = id === sectionId ? 'block' : 'none';
        }
    });

    if (sectionId === 'created-pages' && typeof loadProperties === 'function') {
        loadProperties();
    }

    if (sectionId === 'donnees') {
        setTimeout(() => {
            if (typeof loadStats === 'function') {
                loadStats();
            }
        }, 100);
    }

    if (sectionId === 'orders' && typeof loadOrders === 'function') {
        loadOrders();
    }
}


const entityMap = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
const escapeHtml = (value) => { 
    if (value === null || value === undefined) return 'X'; 
    return String(value).replace(/[&<>"']/g, char => entityMap[char] || char).trim() || 'X';
};
const escapeJsString = (value) => { 
    if (value === null || value === undefined) return ''; 
    return String(value).replace(/\\/g, '\\\\').replace(/'/g, "\\'"); 
};
const formatNumber = (value) => (value === 0 || value) ? escapeHtml(value) : 'X';
const boolIcon = (value) => (value === true) ? '<span style="color: green;">✓</span>' : 'X'; 

function loadLandingPages() {
    try {
        fetch('/user/landing-pages')
            .then(function (response) {
                if (!response.ok) throw new Error('Erreur lors du chargement des données');
                return response.json();
            })
            .then(function (landingPages) {
                var landingPagesList = document.getElementById('properties-list');
                var noPropertiesMessage = document.getElementById('no-properties-message');

                if (!landingPagesList) return;

                landingPagesList.innerHTML = '';

                var htmlLocale = document.documentElement.lang || 'fr';
                var numberLocale = htmlLocale === 'en' ? 'en-GB' : 'fr-FR';
                var currencySymbol = '€';

                var COPY_TITLE = "Copier l'URL";
                var SHOW_URL_TITLE = "Afficher l'URL";
                var QR_CODE_TITLE = "QR Code";
                var BROADCAST_TITLE = "Diffuser";
                var EDIT_TITLE = "Modifier";
                var ACTIVE_ORDER_TITLE = "Commande active en cours";
                var EDIT_DISABLED_TITLE = "Modification temporairement désactivée";
                var URL_UNAVAILABLE_TITLE = "URL indisponible";
                var DETAILS_LABEL = "Détails";

                function formatPrice(value) {
                    if (typeof value === 'number' && !isNaN(value)) {
                        return value.toLocaleString(numberLocale) + ' ' + currencySymbol;
                    }
                    if (typeof value === 'string') {
                        var trimmed = value.trim();
                        if (!trimmed) return 'X';
                        if (trimmed.indexOf(currencySymbol) !== -1) {
                            return escapeHtml(trimmed);
                        }
                        return escapeHtml(trimmed) + ' ' + currencySymbol;
                    }
                    return 'X';
                }

                function normalizeUrlPath(value) {
                    if (!value && value !== 0) return '';
                    var raw = String(value).trim();
                    if (!raw) return '';
                    try {
                        var parsed = raw.indexOf('http') === 0 ? new URL(raw) : new URL(raw, 'https://uap.immo');
                        var path = (parsed.pathname || '') + (parsed.search || '') + (parsed.hash || '');
                        if (path && path !== 'null') {
                            return path.charAt(0) === '/' ? path : '/' + path;
                        }
                        return '';
                    } catch (e) {
                        return raw.charAt(0) === '/' ? raw : '/' + raw;
                    }
                }

                function buildFullUrl(path) {
                    if (!path) return '';
                    return path.indexOf('http') === 0 ? path : 'https://uap.immo' + path;
                }

                if (!landingPages || !landingPages.length) {
                    if (noPropertiesMessage) noPropertiesMessage.style.display = 'block';
                    return;
                }
                if (noPropertiesMessage) noPropertiesMessage.style.display = 'none';

                landingPages.forEach(function (property) {
                    var row = document.createElement('tr');

                    var photos = Array.isArray(property.photos) ? property.photos : [];
                    var mainPhotos = photos.slice(0, 2);
                    var extraPhotos = photos.slice(2, 10).filter(Boolean);
                    var miniPhotos = photos.slice(10, 13).filter(Boolean);

                    var rawDescription = property.description || '';
                    var truncatedDescription = rawDescription.length > 80
                        ? rawDescription.slice(0, 80) + '…'
                        : rawDescription;

                    var normalizedPath = normalizeUrlPath(property.url);
                    var hasUrl = !!normalizedPath;
                    var fullUrl = hasUrl ? buildFullUrl(normalizedPath) : '';
                    var normalizedPathAttr = hasUrl ? escapeHtml(normalizedPath) : '';

                    var hasId = property && property._id;
                    var safeIdAttr = hasId ? escapeHtml(String(property._id)) : '';

                    var detailsData = JSON.stringify(property).replace(/'/g, "&apos;");
                    var disabledByOrder = !!property.hasActiveOrder;

                    // Boutons actions
                    var copyButtonHtml;
                    if (hasUrl) {
                        copyButtonHtml =
                            '<button class="btn btn-sm btn-outline-dark copy-btn" data-url="' + normalizedPathAttr +
                            '" title="' + escapeHtml(COPY_TITLE) + '">' +
                            '<i class="bi bi-clipboard"></i>' +
                            '</button>';
                    } else {
                        copyButtonHtml =
                            '<button class="btn btn-sm btn-outline-secondary disabled" type="button" title="' + escapeHtml(URL_UNAVAILABLE_TITLE) + '">' +
                            '<i class="bi bi-clipboard"></i>' +
                            '</button>';
                    }

                    var showUrlButtonHtml;
                    if (hasUrl) {
                        showUrlButtonHtml =
                            '<button class="btn btn-sm btn-outline-dark show-url-btn" data-url="' + normalizedPathAttr +
                            '" title="' + escapeHtml(SHOW_URL_TITLE) + '">' +
                            '<i class="bi bi-link-45deg"></i>' +
                            '</button>';
                    } else {
                        showUrlButtonHtml =
                            '<button class="btn btn-sm btn-outline-secondary disabled" type="button" title="' + escapeHtml(URL_UNAVAILABLE_TITLE) + '">' +
                            '<i class="bi bi-link-45deg"></i>' +
                            '</button>';
                    }

                    var qrButtonHtml;
                    if (hasUrl && hasId) {
                        qrButtonHtml =
                            '<button class="btn btn-sm btn-qr qr-code-btn" data-id="' + safeIdAttr +
                            '" data-url="' + normalizedPathAttr + '" title="' + escapeHtml(QR_CODE_TITLE) + '">' +
                            '<i class="bi bi-qr-code"></i>' +
                            '</button>';
                    } else {
                        qrButtonHtml =
                            '<button class="btn btn-sm btn-outline-secondary disabled" type="button" title="' + escapeHtml(URL_UNAVAILABLE_TITLE) + '">' +
                            '<i class="bi bi-qr-code"></i>' +
                            '</button>';
                    }

                    var broadcastButtonHtml;
                    if (hasId && !disabledByOrder) {
                        broadcastButtonHtml =
                            '<button class="btn btn-sm btn-dark broadcast-btn" data-id="' + safeIdAttr +
                            '" title="' + escapeHtml(BROADCAST_TITLE) + '">' +
                            '<i class="bi bi-megaphone"></i>' +
                            '</button>';
                    } else {
                        broadcastButtonHtml =
                            '<button class="btn btn-sm ' + (disabledByOrder ? 'btn-warning' : 'btn-outline-secondary') +
                            ' disabled" type="button" title="' + escapeHtml(disabledByOrder ? ACTIVE_ORDER_TITLE : URL_UNAVAILABLE_TITLE) + '">' +
                            '<i class="bi bi-megaphone"></i>' +
                            '</button>';
                    }

                    var editButtonHtml;
                    if (hasId && !disabledByOrder) {
                        editButtonHtml =
                            '<button class="btn btn-sm btn-success edit-btn" data-id="' + safeIdAttr +
                            '" title="' + escapeHtml(EDIT_TITLE) + '">' +
                            '<i class="bi bi-pencil-square"></i>' +
                            '</button>';
                    } else {
                        editButtonHtml =
                            '<button class="btn btn-sm ' + (disabledByOrder ? 'btn-secondary' : 'btn-outline-secondary') +
                            ' disabled" type="button" title="' + escapeHtml(EDIT_DISABLED_TITLE) + '">' +
                            '<i class="bi bi-pencil-square"></i>' +
                            '</button>';
                    }

                    // Construction des cellules dans le même ordre que le <thead>
                    var cells = [];

                    // 1. ID
                    if (hasId) {
                        if (hasUrl) {
                            cells.push(
                                '<a href="' + escapeHtml(fullUrl) + '" target="_blank" rel="noopener">' +
                                escapeHtml(property._id) +
                                '</a>'
                            );
                        } else {
                            cells.push(escapeHtml(property._id));
                        }
                    } else {
                        cells.push('X');
                    }

                    // 2. Type
                    cells.push(escapeHtml(property.propertyType || 'X'));

                    // 3–5 Rooms / Bedrooms / Surface
                    cells.push(formatNumber(property.rooms));
                    cells.push(formatNumber(property.bedrooms));
                    cells.push(formatNumber(property.surface));

                    // 6. Price
                    cells.push(formatPrice(property.price));

                    // 7–9 Country / City / Postal code
                    cells.push(escapeHtml(property.country || 'X'));
                    cells.push(escapeHtml(property.city || 'X'));
                    cells.push(escapeHtml(property.postalCode || 'X'));

                    // 10. Year
                    cells.push(formatNumber(property.yearBuilt));

                    // 11. DPE
                    cells.push(escapeHtml(property.dpe || 'X'));

                    // 12. Language
                    cells.push(escapeHtml((property.language || 'X').toUpperCase()));

                    // 13–21 Équipements
                    cells.push(boolIcon(property.pool));
                    cells.push(boolIcon(property.doubleGlazing));
                    cells.push(boolIcon(property.wateringSystem));
                    cells.push(boolIcon(property.barbecue));
                    cells.push(boolIcon(property.carShelter));
                    cells.push(boolIcon(property.parking));
                    cells.push(boolIcon(property.caretakerHouse));
                    cells.push(boolIcon(property.electricShutters));
                    cells.push(boolIcon(property.outdoorLighting));

                    // 22–25 Photos
                    cells.push(mainPhotos[0] ? '✓' : 'X');
                    cells.push(mainPhotos[1] ? '✓' : 'X');
                    cells.push(extraPhotos.length ? String(extraPhotos.length) : 'X');
                    cells.push(miniPhotos.length ? String(miniPhotos.length) : 'X');

                    // 26. Vidéo
                    if (property.videoUrl) {
                        cells.push(
                            '<a href="' + escapeHtml(property.videoUrl) + '" target="_blank" rel="noopener">URL</a>'
                        );
                    } else {
                        cells.push('X');
                    }

                    // 27. Contact
                    var contactName = [property.contactFirstName, property.contactLastName].filter(Boolean).join(' ');
                    cells.push(escapeHtml(contactName || 'X'));

                    // 28. Téléphone
                    cells.push(escapeHtml(property.contactPhone || 'X'));

                    // 29. Description
                    if (rawDescription) {
                        cells.push(
                            '<span title="' + escapeHtml(rawDescription) + '">' +
                            escapeHtml(truncatedDescription) +
                            '</span>'
                        );
                    } else {
                        cells.push('X');
                    }

                    // 30. Actions
                    cells.push(
                        '<div class="table-action-buttons d-flex flex-nowrap gap-1">' +
                        showUrlButtonHtml +
                        copyButtonHtml +
                        qrButtonHtml +
                        '<button class="btn btn-sm btn-info show-details-btn" data-details=\'' + detailsData +
                        '\' title="' + escapeHtml(DETAILS_LABEL) + '">' +
                        '<i class="bi bi-info-circle"></i>' +
                        '</button>' +
                        broadcastButtonHtml +
                        editButtonHtml +
                        '</div>'
                    );

                    // Injection dans le <tr>
                    row.innerHTML = cells.map(function (c) {
                        return '<td class="text-nowrap">' + c + '</td>';
                    }).join('');

                    landingPagesList.appendChild(row);
                });

                // Actions JS sur les boutons
                var copyButtons = document.querySelectorAll('.copy-btn');
                Array.prototype.forEach.call(copyButtons, function (button) {
                    button.addEventListener('click', function () {
                        var urlPath = this.getAttribute('data-url');
                        if (!urlPath) return;
                        var full = buildFullUrl(urlPath);
                        navigator.clipboard.writeText(full).then(function () {
                            var icon = button.querySelector('i');
                            if (!icon) return;
                            icon.classList.remove('bi-clipboard');
                            icon.classList.add('bi-check-circle-fill', 'text-success');
                            setTimeout(function () {
                                icon.classList.remove('bi-check-circle-fill', 'text-success');
                                icon.classList.add('bi-clipboard');
                            }, 1500);
                        });
                    });
                });

                var showUrlButtons = document.querySelectorAll('.show-url-btn');
                Array.prototype.forEach.call(showUrlButtons, function (button) {
                    button.addEventListener('click', function () {
                        var urlPath = button.getAttribute('data-url');
                        if (!urlPath) return;
                        var full = buildFullUrl(urlPath);
                        var el = document.getElementById('urlModalText');
                        if (el) el.textContent = full;
                        if (window.bootstrap && bootstrap.Modal) {
                            var modal = new bootstrap.Modal(document.getElementById('urlModal'));
                            modal.show();
                        }
                    });
                });

                var qrButtons = document.querySelectorAll('.qr-code-btn');
                Array.prototype.forEach.call(qrButtons, function (button) {
                    button.addEventListener('click', function () {
                        var id = button.getAttribute('data-id');
                        var urlPath = button.getAttribute('data-url');
                        if (!id || !urlPath) return;
                        if (typeof showQRCode === 'function') {
                            showQRCode(id, urlPath);
                        }
                    });
                });

                var broadcastButtons = document.querySelectorAll('.broadcast-btn');
                Array.prototype.forEach.call(broadcastButtons, function (button) {
                    button.addEventListener('click', function () {
                        var id = button.getAttribute('data-id');
                        if (!id) return;
                        if (typeof redirectToPayment === 'function') {
                            redirectToPayment(id);
                        }
                    });
                });

                var editButtons = document.querySelectorAll('.edit-btn');
                Array.prototype.forEach.call(editButtons, function (button) {
                    button.addEventListener('click', function () {
                        var id = button.getAttribute('data-id');
                        if (!id) return;
                        if (typeof editProperty === 'function') {
                            editProperty(id);
                        }
                    });
                });

            })
            .catch(function (error) {
                console.error('❌ Erreur lors du chargement des landing pages :', error);
                var landingPagesList = document.getElementById('properties-list');
                if (landingPagesList) {
                    landingPagesList.innerHTML =
                        '<tr><td colspan="30" class="text-center">Erreur lors du chargement des landing pages.</td></tr>';
                }
            });
    } catch (e) {
        console.error('❌ Exception loadLandingPages :', e);
    }
}
</script>


<script>
  const descriptionInput = document.getElementById('description');
  const charCount = document.getElementById('charCount');

  descriptionInput.addEventListener('input', function() {
    charCount.textContent = `${descriptionInput.value.length}/820 caractères`;
  });
</script>
<script>
document.getElementById('add-property-form').addEventListener('submit', async function(event) {
    event.preventDefault();
    
    const formData = new FormData(this);
    const generatedLinkContainer = document.getElementById('generatedLink');
    const submitButton = this.querySelector('button[type="submit"]');

    // Désactiver le bouton et montrer un spinner
    if (submitButton) {
        submitButton.disabled = true;
        submitButton.innerHTML = `<i class="fa fa-spinner fa-spin me-2"></i> <%= i18n.creating_ad || "Création en cours..." %>`;
    }
    
    try {
        const response = await fetch('/add-property', {
            method: 'POST',
            body: formData
        });

        const result = await response.text(); // 'result' est le message HTML de succès

        if (!response.ok) {
            // Gérer les erreurs serveur (400, 500 etc.)
            generatedLinkContainer.innerHTML = `<div class="alert alert-danger">${result || '<%= i18n.error_creating_ad || "Une erreur est survenue." %>'}</div>`;
            if (submitButton) {
                submitButton.disabled = false;
                submitButton.innerHTML = `<i class="fa fa-check-circle me-2"></i><%= i18n.create_ad %>`;
            }
            return; // Arrêter ici
        }

        // Succès ! Afficher le message du serveur (avec l'URL)
        generatedLinkContainer.innerHTML = result;
        
        // Créer et ajouter le message de redirection
        const redirectMessage = document.createElement('div');
        redirectMessage.className = 'alert alert-info mt-2';
        redirectMessage.innerHTML = '🎉 <%= i18n.redirect_message || "Redirection vers votre espace..." %>';
        generatedLinkContainer.appendChild(redirectMessage);

        this.reset(); // Vider le formulaire
        
        // Scroller jusqu'au message
        generatedLinkContainer.scrollIntoView({ behavior: 'smooth' });

        // Sauvegarder l'onglet cible dans le localStorage
        localStorage.setItem('defaultSection', 'created-pages');

        // Recharger la page après 3 secondes
        setTimeout(() => {
            location.reload();
        }, 3000); // Délai de 3 secondes

    } catch (error) {
        console.error('Erreur lors de l\'ajout de la propriété :', error);
        generatedLinkContainer.innerHTML = `<div class="alert alert-danger"><%= i18n.error_creating_ad || "Une erreur est survenue." %></div>`;
        // Réactiver le bouton en cas d'erreur
        if (submitButton) {
            submitButton.disabled = false;
            submitButton.innerHTML = `<i class="fa fa-check-circle me-2"></i><%= i18n.create_ad %>`;
        }
    }
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    function handleFileUpload(input, progressId, statusId) {
        const file = input.files[0];

        if (file) {
            const progressBar = document.getElementById(progressId);
            const status = document.getElementById(statusId);

            // Réinitialisation
            progressBar.value = 0;
            progressBar.classList.remove("hidden");
            status.classList.remove("hidden");
            status.textContent = "Chargement en cours...";

            // Simulation d'upload progressif (remplace ça par une vraie requête si besoin)
            let progress = 0;
            const interval = setInterval(() => {
                progress += 10;
                progressBar.value = progress;

                if (progress >= 100) {
                    clearInterval(interval);
                    status.textContent = "✅ Image chargée avec succès !";
                    setTimeout(() => {
                        progressBar.classList.add("hidden");
                        status.classList.add("hidden");
                    }, 2000); // Cache après 2 secondes
                }
            }, 200);
        }
    }

    // Événements sur les inputs file
    document.getElementById("photo1").addEventListener("change", function () {
        handleFileUpload(this, "progress1", "status1");
    });

    document.getElementById("photo2").addEventListener("change", function () {
        handleFileUpload(this, "progress2", "status2");
    });

    const extraPhotoIds = Array.from({ length: 8 }, (_, i) => i + 1);
    const extraPhotoElements = extraPhotoIds.map(i => {
        const input = document.getElementById(`extraPhoto${i}`);
        const preview = document.getElementById(`extraPreview${i}`);
        input.addEventListener("change", function () {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    preview.src = e.target.result;
                    preview.classList.remove("d-none");
                };
                reader.readAsDataURL(file);
            } else {
                preview.src = "";
                preview.classList.add("d-none");
            }
        });
        return { input, preview };
    });

    const miniPhotosInput = document.getElementById("miniPhotos");
    const miniPreview = document.getElementById("miniPhotosPreview");
    miniPhotosInput.addEventListener("change", function () {
        miniPreview.innerHTML = "";
        if (this.files.length > 3) {
            alert("Vous pouvez télécharger jusqu'à 3 photos.");
            this.value = "";
            return;
        }
        Array.from(this.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = e => {
                const img = document.createElement("img");
                img.src = e.target.result;
                img.classList.add("border", "rounded");
                img.style.height = "60px";
                img.style.objectFit = "cover";
                miniPreview.appendChild(img);
            };
            reader.readAsDataURL(file);
        });
    });

    const videoInput = document.getElementById("videoUrl");
    const mainPhotoInputs = [document.getElementById("photo1"), document.getElementById("photo2")];
    const progressBars = [
        { progress: document.getElementById("progress1"), status: document.getElementById("status1") },
        { progress: document.getElementById("progress2"), status: document.getElementById("status2") }
    ];
    const mediaNotice = document.getElementById("mediaNotice");

    function resetMainPhotoFeedback() {
        progressBars.forEach(({ progress, status }) => {
            if (progress) {
                progress.value = 0;
                progress.style.display = "none";
            }
            if (status) {
                status.textContent = "";
            }
        });
    }

    function clearFileInput(input) {
        if (!input) return;
        input.value = "";
        const event = new Event("change");
        input.dispatchEvent(event);
    }

    function toggleMediaFields(hasVideo) {
        mainPhotoInputs.forEach(input => {
            if (!input) return;
            input.required = !hasVideo;
        });

        if (hasVideo) {
            resetMainPhotoFeedback();
            if (mediaNotice) {
                mediaNotice.textContent = "Vous avez renseigné un lien vidéo. Ajoutez également des photos pour enrichir la galerie \"Découvrez le bien\".";
                mediaNotice.classList.remove("text-muted", "text-danger");
                mediaNotice.classList.add("text-info");
            }
        } else if (mediaNotice) {
            mediaNotice.textContent = "Ajoutez vos photos ou indiquez un lien vidéo plein écran.";
            mediaNotice.classList.remove("text-info", "text-danger");
            mediaNotice.classList.add("text-muted");
        }
    }

    if (videoInput) {
        videoInput.addEventListener("input", function () {
            const hasVideo = this.value.trim().length > 0;
            toggleMediaFields(hasVideo);
        });
        toggleMediaFields(videoInput.value.trim().length > 0);
    }
});
</script>
<script>
function downloadInvoice(orderId) {
  window.open(`/user/orders/${orderId}/invoice`, '_blank');
}

function formatDate(dateString) {
  const date = new Date(dateString);
  const day = String(date.getDate()).padStart(2, '0');
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const year = date.getFullYear();
  return `${day}-${month}-${year}`;
}

async function loadOrders() {
  try {
    const response = await fetch('/user/orders');
    if (!response.ok) throw new Error('Erreur lors du chargement des commandes.');

    const orders = await response.json();
    const ordersList = document.getElementById('orders-list');
    const msg = document.getElementById('no-orders-message');
    
    // Nettoyage
    ordersList.innerHTML = '';

    if (orders.length === 0) {
      if (msg) msg.style.display = 'block';
    } else {
      if (msg) msg.style.display = 'none';
      
      orders.forEach(order => {
        const orderDate = new Date(order.createdAt).toLocaleDateString('fr-FR');
        const expiryDate = order.expiryDate ? new Date(order.expiryDate).toLocaleDateString('fr-FR') : '-';
        
        // 1. Badge Statut
        const statusBadge = order.status === 'paid' 
            ? '<span class="badge bg-success">Payé</span>' 
            : '<span class="badge bg-warning text-dark">En attente</span>';

        // 2. Badge Moyen de Paiement (NOUVEAU)
        let paymentBadge = '';
        if (order.btcPayInvoiceId) {
            paymentBadge = '<span class="badge bg-warning text-dark"><i class="bi bi-currency-bitcoin"></i> Bitcoin</span>';
        } else {
            // Par défaut PayPal si pas d'ID BTCPay
            paymentBadge = '<span class="badge bg-primary"><i class="bi bi-paypal"></i> PayPal</span>';
        }

        // 3. Barre de progression
        const today = new Date();
        const exp = new Date(order.expiryDate);
        const timeDiff = exp - today;
        const daysRemaining = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
        const adjustedDays = daysRemaining >= 0 ? daysRemaining : 0;
        const progress = Math.min(((90 - adjustedDays) / 90) * 100, 100);

        let progressBarColor = '#8BC34A';
        if (adjustedDays <= 30) progressBarColor = '#FFC107';
        if (adjustedDays <= 15) progressBarColor = '#FF5722';

        let daysDisplay = 'Expiré';
        if (order.status === 'paid' && adjustedDays > 0) {
            daysDisplay = `
                ${adjustedDays} jours
                <div class="progress" style="height: 6px; margin-top: 5px; width: 100px;">
                    <div class="progress-bar" role="progressbar" style="width: ${progress}%; background-color: ${progressBarColor};"></div>
                </div>`;
        } else if (order.status !== 'paid') {
            daysDisplay = '-';
        }

        const url = order.propertyId?.url || `/landing-pages/${order.propertyId?._id}.html`;
        
        // Boutons Actions
        let actions = `
            <button class="btn btn-sm btn-outline-dark me-1 copy-btn" data-url="${url}" title="Copier l'URL"><i class="bi bi-clipboard"></i></button>
            <button class="btn btn-sm btn-dark me-1" onclick="window.open('https://uap.immo${url}', '_blank')" title="Voir"><i class="bi bi-eye"></i></button>
        `;

        if (order.status === 'paid') {
            actions += `<button class="btn btn-sm btn-outline-danger" onclick="downloadInvoice('${order._id}')" title="Facture"><i class="bi bi-file-earmark-text"></i></button>`;
        } else {
            actions += `<button class="btn btn-sm btn-outline-secondary disabled"><i class="bi bi-file-earmark-text"></i></button>`;
        }

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${order.orderId || order._id}</td>
          <td>${orderDate}</td>
          <td>${statusBadge}</td>
          <td>${paymentBadge}</td> <!-- NOUVELLE COLONNE ICI -->
          <td>${daysDisplay}</td>
          <td>${expiryDate}</td>
          <td>${actions}</td>
        `;
        ordersList.appendChild(row);
      });
    }

    // Réactiver les boutons copier
    document.querySelectorAll('#orders-list .copy-btn').forEach(button => {
      button.addEventListener('click', function () {
        const url = `https://uap.immo${this.dataset.url}`;
        navigator.clipboard.writeText(url).then(() => {
          const icon = this.querySelector('i');
          icon.classList.remove('bi-clipboard');
          icon.classList.add('bi-check-circle-fill', 'text-success');
          setTimeout(() => {
            icon.classList.remove('bi-check-circle-fill', 'text-success');
            icon.classList.add('bi-clipboard');
          }, 1500);
        });
      });
    });
  } catch (error) {
    const list = document.getElementById('orders-list');
    if(list) list.innerHTML = '<tr><td colspan="7" class="text-center">Erreur lors du chargement des commandes.</td></tr>';
    console.error(error);
  }
}

function showSection(sectionId) {
  const sections = ['account', 'landing', 'donnees', 'created-pages', 'orders'];
  if (document.getElementById('admin-users')) {
    sections.push('admin-users');
  }
  if (document.getElementById('admin-properties')) {
    sections.push('admin-properties');
  }
  if (document.getElementById('admin-orders')) {
    sections.push('admin-orders');
  }

  sections.forEach(id => {
    const section = document.getElementById(id);
    if (section) {
      section.style.display = id === sectionId ? 'block' : 'none';
    }
  });

  if (sectionId === 'orders' && typeof loadOrders === 'function') {
    loadOrders();
  }
  if (sectionId === 'created-pages' && typeof loadLandingPages === 'function') {
    loadLandingPages();
  }
  if (sectionId === 'donnees' && typeof loadStats === 'function') {
    loadStats();
  }
}
</script>


<script>
document.addEventListener('click', function (event) {
  if (event.target.closest('.show-details-btn')) {
    const btn = event.target.closest('.show-details-btn');
    try {
      const data = JSON.parse(btn.dataset.details.replace(/&apos;/g, "'"));
      showPageDetails(data);
    } catch (e) {
      console.error("Erreur lors du parsing JSON :", e);
    }
  }
});
</script>

<script>
async function renewOrder(orderId) { 
  try { 
    const response = await fetch('/user/orders/renew', { 
      method: 'POST', 
      headers: { 'Content-Type': 'application/json' }, 
      body: JSON.stringify({ orderId }) 
    });

    const result = await response.json();
    if (response.ok) { 
      alert('Commande renouvelée avec succès !'); 
      loadOrders(); // Recharger la liste des commandes 
    } else { 
      alert(result.error || 'Erreur lors du renouvellement de la commande.'); 
    }
  } catch (error) { 
    console.error('Erreur lors du renouvellement :', error); 
    alert('Une erreur est survenue.'); 
  }
}
</script>
<script>
async function loadStats() {
  try {
    const statsList = document.getElementById('stats-table-body');
    if (!statsList) {
      console.warn('⚠️ statsTableBody non trouvé dans le DOM');
      return;
    }

    // Obtenir les dates depuis le formulaire
    const startDate = document.getElementById('startDate')?.value || '30daysAgo';
    const endDate = document.getElementById('endDate')?.value || 'today';

    statsList.innerHTML = '';

    const response = await fetch('/user/landing-pages');
    const pages = await response.json();

    for (const page of pages) {
      const pageId = page._id;
      const pageUrl = page.url;

      const res = await fetch(`/api/stats/${pageId}?startDate=${startDate}&endDate=${endDate}`);
      const contentType = res.headers.get("content-type");

      if (!contentType || !contentType.includes("application/json")) {
        const text = await res.text();
        console.error("❌ Réponse non JSON :", text);
        continue;
      }

          const data = await res.json();
      if (data.error) {
        console.error(`❌ Erreur pour la page ${pageId} :`, data.error);
        continue;
      }

      const views = data.views || 0;
      const users = data.users || 0;

      // ➕ Ajouter ici :
      const scrolls = data.scrolls || 0;
      const geo = data.geo || {};
      const device = data.deviceCategory || 'N/A';
      const os = data.operatingSystem || 'N/A';
      const browser = data.browser || 'N/A';
      const lang = data.language || 'N/A';
      const source = data.sessionDefaultChannelGroup || data.channel || 'N/A';

      // Ne pas afficher les lignes sans données
      if (views === 0 && users === 0) continue;

      const row = document.createElement('tr');
     row.innerHTML = `
  <td><a href="${pageUrl}" target="_blank">${pageUrl}</a></td>
  <td>${views}</td>
  <td>${users}</td>
  <td>${scrolls}</td>
  <td>${source}</td>
  <td>${geo.country || '—'}${geo.region ? ', ' + geo.region : ''}${geo.city ? ', ' + geo.city : ''}</td>
  <td>${device}</td>
  <td>${os}</td>
  <td>${browser}</td>
  <td>${lang}</td>
`;

      statsList.appendChild(row);
    }

    // Ajouter les événements après l'injection
    document.querySelectorAll('.copy-btn').forEach(button => {
      button.addEventListener('click', function () {
        const url = `https://uap.immo${this.dataset.url}`;
        navigator.clipboard.writeText(url).then(() => {
          const icon = this.querySelector('i');
          icon.classList.remove('bi-clipboard');
          icon.classList.add('bi-check-circle-fill', 'text-success');

          setTimeout(() => {
            icon.classList.remove('bi-check-circle-fill', 'text-success');
            icon.classList.add('bi-clipboard');
          }, 1500);
        });
      });
    });

  } catch (error) {
    console.error('❌ Erreur lors du chargement des statistiques:', error);
    const statsList = document.getElementById('statsTableBody');
    if (statsList) {
      statsList.innerHTML = '<tr><td colspan="5">❌ Erreur lors du chargement des statistiques.</td></tr>';
    }
  }
}
</script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Regarde si on a sauvegardé un onglet cible (après la création d'une page)
    const savedSection = localStorage.getItem('defaultSection');
    
    if (savedSection) {
      showSection(savedSection); // Affiche l'onglet 'created-pages'
      localStorage.removeItem('defaultSection'); // Nettoie le localStorage
    } else {
      // Comportement normal
      const defaultSection = '<%= activeSection || 'account' %>';
      showSection(defaultSection);
    }
  });
</script>

<script>
  document.getElementById('disable2FABtn')?.addEventListener('click', async () => {
    if (!confirm('Souhaitez-vous vraiment désactiver la 2FA ?')) return;

    const res = await fetch('/disable-2fa', { method: 'POST' });
    const result = await res.json();

    if (result.success) {
      document.getElementById('2fa-message').innerHTML = '<div class="alert alert-success">✅ 2FA désactivée avec succès</div>';
      setTimeout(() => location.reload(), 2000);
    } else {
      document.getElementById('2fa-message').innerHTML = '<div class="alert alert-danger">❌ Erreur : ' + result.error + '</div>';
    }
  });
</script>

<script>
document.getElementById('statsFilter').addEventListener('submit', async (e) => {
  e.preventDefault();
  const startDate = e.target.startDate.value;
  const endDate = e.target.endDate.value;

  const res = await fetch(`/api/stats/<%= user._id %>?startDate=${startDate}&endDate=${endDate}`);
  const stats = await res.json();

  const tbody = document.querySelector('#statsTable tbody');
  tbody.innerHTML = '';

  stats.forEach(stat => {
    const row = `
      <tr>
    <td>${stat.pagePath}</td>
    <td>${stat.views}</td>
    <td>${stat.users}</td>
    <td>${stat.source}</td>
  </tr>`;
    tbody.insertAdjacentHTML('beforeend', row);
  });
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const descriptionInput = document.getElementById('description');
  const charCount = document.getElementById('charCount');

  descriptionInput.addEventListener('input', function () {
    const count = descriptionInput.value.length;
    charCount.textContent = `${count}/820 caractères`;

    if (count > 750) {
      charCount.style.color = '#dc3545'; // rouge
    } else {
      charCount.style.color = '#6c757d'; // gris
    }
  });
});
</script>
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailsModalLabel">Détails de la propriété</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body" id="modalDetailsBody">
        <!-- Contenu injecté par JS -->
      </div>
    </div>
  </div>
</div>

<!-- Modal QR Code -->
<div class="modal fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header flex-column align-items-start">
  <h5 class="modal-title" id="qrModalLabel">QR Code</h5>
  <p class="mb-0 small text-muted">Scannez pour visualiser et partager facilement votre annonce</p>
  <button type="button" class="btn-close position-absolute top-0 end-0 mt-2 me-2" data-bs-dismiss="modal" aria-label="Fermer"></button>
</div>

      <div class="modal-body text-center">
        <div id="qrCodeContainer">
          <!-- QR code généré s'affichera ici -->
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Chargement...</span>
          </div>
        </div>
        <div id="qrModalActions" class="mt-3">
          <p id="qrModalUrl" class="text-break small mb-2"></p>
          <button class="btn btn-sm btn-outline-dark me-1" id="copyQrUrl">
            <i class="bi bi-clipboard"></i> <%= i18n.copy_url %>
          </button>
          <a class="btn btn-sm btn-outline-primary" id="openQrUrl" target="_blank">
            <i class="bi bi-box-arrow-up-right"></i> <%= i18n.open_page %>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="urlModal" tabindex="-1" aria-labelledby="urlModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="urlModalLabel"><%= i18n.url_modal_title %></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <p id="urlModalText" class="text-break mb-3"></p>
        <button class="btn btn-sm btn-outline-dark" id="copyUrlFromModal">
          <i class="bi bi-clipboard"></i> <%= i18n.copy_url %>
        </button>
      </div>
    </div>
  </div>
</div>
<script>
function showQRCode(propertyId, pageUrl) {
  const qrContainer = document.getElementById('qrCodeContainer');
  qrContainer.innerHTML = `
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Chargement...</span>
    </div>
  `;

  const url = `https://uap.immo${pageUrl}`;
  document.getElementById('qrModalUrl').textContent = url;
  document.getElementById('openQrUrl').href = url;
  const copyBtn = document.getElementById('copyQrUrl');
  copyBtn.onclick = () => {
    navigator.clipboard.writeText(url).then(() => {
      showCopyMessage();
    });
  };

  // Affiche la modale
  const qrModal = new bootstrap.Modal(document.getElementById('qrModal'));
  qrModal.show();

  // Charge le QR Code
  fetch(`/qr/${propertyId}`)
    .then(response => response.text())
    .then(html => {
      qrContainer.innerHTML = html;
    })
    .catch(err => {
      qrContainer.innerHTML = `<p class="text-danger">Erreur de génération du QR code</p>`;
      console.error(err);
    });
}
</script>
<script>
function showPageDetails(page) {
  const data = typeof page === 'string' ? JSON.parse(decodeURIComponent(page)) : page;
  const html = `
  <p><strong>ID :</strong> ${data._id}</p>
  <p><strong>Type :</strong> ${data.propertyType ?? 'N/A'}</p>
  <p><strong>Pays :</strong> ${data.country ?? 'N/A'}</p>
  <p><strong>Ville :</strong> ${data.city ?? 'N/A'}</p>
  <p><strong>Surface :</strong> ${data.surface ?? 'N/A'} m²</p>
  <p><strong>Prix :</strong> ${data.price?.toLocaleString('fr-FR') ?? 'N/A'} €</p>
  <p><strong>Année :</strong> ${data.yearBuilt ?? 'N/A'}</p>
  <p><strong>DPE :</strong> ${data.dpe ?? 'N/A'}</p>
  <p><strong>Description :</strong><br>${data.description ?? ''}</p>
  <div class="text-end mt-4">
   <button class="btn btn-sm btn-dark" onclick="editProperty('${data._id}')">
      <i class="bi bi-pencil-square me-1"></i> Modifier
    </button>
  </div>
`;
  document.getElementById('modalDetailsBody').innerHTML = html;
  const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
  modal.show();
}
</script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const tooltipElements = document.querySelectorAll('[data-bs-toggle="tooltip"], [title]:not(.sidebar a)');
    tooltipElements.forEach(el => {
      new bootstrap.Tooltip(el);
    });
    const copyBtnModal = document.getElementById('copyUrlFromModal');
    if (copyBtnModal) {
      copyBtnModal.addEventListener('click', () => {
        const url = document.getElementById('urlModalText').textContent;
        navigator.clipboard.writeText(url).then(() => {
          showCopyMessage();
        });
      });
    }
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const defaultSection = '<%= activeSection || 'account' %>';
    showSection(defaultSection);
  });
</script>

<script>
/**
 * Redirige vers la page de modification de la propriété en incluant la locale.
 * @param {string} propertyId L'ID de la propriété à modifier.
 */
function editProperty(propertyId) {
    // Utilise la variable EJS 'locale' passée à la vue.
    const locale = '<%= locale %>'; 
    
    // Redirection vers la route Express (qui est gérée par le routeur property)
    window.location.href = `/${locale}/property/edit/${propertyId}`;
}
</script>
<script>
/**
 * Redirige l'utilisateur vers la page de paiement pour commander
 * un pack de diffusion pour la propriété spécifiée.
 * @param {string} propertyId L'ID de la propriété à diffuser.
 */
function redirectToPayment(propertyId) {
    // 1. Récupère la locale actuelle (passée via EJS)
    const locale = '<%= locale %>';
    
    // 2. Construit l'URL de redirection
    // Note : Le point de terminaison de paiement attend un query param 'propertyId'
    const redirectUrl = `/${locale}/payment?propertyId=${propertyId}`;
    
    // 3. Effectue la redirection
    window.location.href = redirectUrl;
    
    // Optionnel : Afficher un toast de confirmation juste avant la redirection
    const toast = document.getElementById('toast-confirm');
    if (toast) {
        toast.style.display = 'block';
        setTimeout(() => {
            toast.style.display = 'none';
        }, 3000);
    }
}
</script>
<script>
  /**
   * Fonction appelée par l'attribut onchange des inputs file
   * Permet de simuler une barre de progression pour l'UX
   */
  window.handleFileUpload = function(input, progressId, statusId) {
    const file = input.files[0];
    const progressBar = document.getElementById(progressId);
    const statusSpan = document.getElementById(statusId);

    if (file) {
      // Afficher la barre
      if (progressBar) {
        progressBar.style.display = 'block';
        progressBar.value = 0;
      }
      
      if (statusSpan) {
        statusSpan.style.display = 'inline';
        statusSpan.innerText = 'Analyse...';
        statusSpan.style.color = '#666';
      }

      // Simulation visuelle (l'upload réel se fait au submit du formulaire)
      let progress = 0;
      const interval = setInterval(() => {
        progress += 10;
        if (progressBar) progressBar.value = progress;
        
        if (progress >= 100) {
          clearInterval(interval);
          if (statusSpan) {
            statusSpan.innerText = 'Prêt à envoyer';
            statusSpan.style.color = 'green';
          }
        }
      }, 50);
    }
  };

  // Gestion de la prévisualisation des photos supplémentaires (Extra Photos)
  document.addEventListener('DOMContentLoaded', function() {
      const extraInputs = document.querySelectorAll('.extra-photo-input');
      extraInputs.forEach(input => {
          input.addEventListener('change', function() {
              const file = this.files[0];
              // On cherche l'image qui suit immédiatement l'input
              const imgPreview = this.nextElementSibling; 
              
              if (file && imgPreview && imgPreview.tagName === 'IMG') {
                  const reader = new FileReader();
                  reader.onload = function(e) {
                      imgPreview.src = e.target.result;
                      imgPreview.classList.remove('d-none');
                  }
                  reader.readAsDataURL(file);
              }
          });
      });
  });
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 1. Navigation Sidebar
    const sectionLinks = document.querySelectorAll('.sidebar a, .sidebar-mobile-links a');
    
    sectionLinks.forEach(link => {
        if (link.href && link.href.includes('#')) {
            const dataSection = link.getAttribute('data-section');
            if (dataSection) {
                link.onclick = null; 
                link.addEventListener('click', function(event) {
                    event.preventDefault(); 
                    showSection(dataSection);
                });
            }
        }
    });

    // 2. Initialisation de la section par défaut
    const savedSection = localStorage.getItem('defaultSection');
    
    if (savedSection) {
        showSection(savedSection); 
        localStorage.removeItem('defaultSection'); 
    } else {
        // Utilisation de guillemets doubles pour éviter les erreurs de syntaxe
        const defaultSection = "<%= activeSection || 'account' %>";
        showSection(defaultSection);
    }

    // 3. SCRIPT DE SAUVEGARDE DE L'ADRESSE (CORRIGÉ)
    const addrForm = document.getElementById('dashboard-address-form');
    if(addrForm) {
        addrForm.addEventListener('submit', async function(e) {
            e.preventDefault(); // Empêche le rechargement de la page (?#)
            
            const btn = document.getElementById('btn-save-addr');
            const originalText = btn.innerText;
            
            // Récupération des valeurs
            const streetVal = document.getElementById('dash-street').value;
            const zipVal = document.getElementById('dash-zip').value;
            const cityVal = document.getElementById('dash-city').value;
            const countryVal = document.getElementById('dash-country').value;

            // Validation simple
            if (!streetVal || !zipVal || !cityVal || !countryVal) {
                alert("Veuillez remplir tous les champs.");
                return;
            }

            btn.disabled = true;
            btn.innerText = 'Sauvegarde...';

            try {
                const response = await fetch('/api/user/update-address', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        street: streetVal, 
                        zipCode: zipVal, 
                        city: cityVal, 
                        country: countryVal 
                    })
                });
                const res = await response.json();

                if(res.success) {
                    // ✅ CORRECTION ICI : On utilise les variables locales (streetVal, etc.) 
                    // au lieu de 'data' qui n'était pas défini.
                    document.getElementById('display-street').innerText = streetVal;
                    document.getElementById('display-zip').innerText = zipVal;
                    document.getElementById('display-city').innerText = cityVal;
                    document.getElementById('display-country').innerText = countryVal;

                    // Bascule affichage
                    document.getElementById('address-display').classList.remove('d-none');
                    document.getElementById('address-empty-msg').classList.add('d-none');
                    
                    // Ferme le formulaire proprement
                    const collapseEl = document.getElementById('editAddressCollapse');
                    // Utilisation robuste de Bootstrap pour fermer
                    if (window.bootstrap) {
                        const bsCollapse = bootstrap.Collapse.getOrCreateInstance(collapseEl);
                        bsCollapse.hide();
                    } else {
                        collapseEl.classList.remove('show');
                    }

                    // Petit feedback visuel ou alerte
                    // alert('Adresse enregistrée avec succès.'); 
                    // (Optionnel: retirer l'alert pour une UX plus fluide si souhaité)
                } else {
                    alert('Erreur: ' + res.message);
                }
            } catch (err) {
                console.error(err);
                alert('Erreur de connexion au serveur.');
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        });
    }
});
</script>
<script>
/**
 * Fonction pour copier le texte complet en mode Admin
 * Déclenchée par un double-clic sur la description
 */
function copyAdminDescription(element) {
    // Récupère le texte complet caché dans l'attribut data-full
    const fullText = element.getAttribute('data-full');
    const originalText = element.innerText; // Le texte tronqué (ex: "Belle maison...")

    if (!fullText) return;

    // Copie dans le presse-papier
    navigator.clipboard.writeText(fullText).then(() => {
        // Feedback visuel : Change le texte et la couleur
        element.innerText = "✅ Copié !";
        element.style.color = "#198754"; // Vert
        element.style.fontWeight = "bold";
        
        // Revient à la normale après 1.5 secondes
        setTimeout(() => {
            element.innerText = originalText;
            element.style.color = "";
            element.style.fontWeight = "";
        }, 1500);
    }).catch(err => {
        console.error('Erreur lors de la copie :', err);
        alert("Impossible de copier le texte.");
    });
}
</script>
<!-- ======================================================= -->
<!-- MODAL / BANDEAU DE CONSENTEMENT COOKIE TECHNIQUE -->
<!-- ======================================================= -->
<div id="cookie-banner" style="
    display: none;
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    max-width: 500px;
    width: 90%;
    padding: 15px 20px;
    background-color: #2c3e50; /* Couleur sombre pour le contraste */
    color: #ffffff;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    z-index: 10000; 
    text-align: center;
">
    <p style="margin: 0 0 10px 0; font-size: 14px;">
        <i class="fas fa-cookie-bite" style="margin-right: 8px;"></i>
        <strong>UAP Immo</strong> utilise des cookies techniques nécessaires au fonctionnement de notre site et ne peuvent pas être désactivés.
    </p>
    <button id="accept-cookies" style="
        background-color: #C4B990; /* Couleur d'accentuation */
        color: #000000;
        border: none;
        padding: 8px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.2s;
        font-size: 14px;
    ">
        J'ai compris
    </button>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const cookieName = 'uap_cookie_consent';
    const expirationDays = 60; // 2 mois environ (60 jours)

    /**
     * Lit la valeur d'un cookie par son nom.
     */
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }

    /**
     * Crée ou met à jour un cookie avec une date d'expiration.
     */
    function setCookie(name, value, days) {
        const d = new Date();
        d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
        const expires = "expires=" + d.toUTCString();
        // Le cookie doit être accessible sur tout le domaine et sécurisé
        document.cookie = name + "=" + value + ";" + expires + ";path=/;secure;samesite=Lax";
    }

    const cookieBanner = document.getElementById('cookie-banner');
    const acceptButton = document.getElementById('accept-cookies');

    // 1. Vérification au chargement
    const consent = getCookie(cookieName);

    if (consent !== 'accepted') {
        // Le cookie n'existe pas ou la valeur est incorrecte, afficher le bandeau
        cookieBanner.style.display = 'block';
    }

    // 2. Gestion du clic
    if (acceptButton) {
        acceptButton.addEventListener('click', function() {
            setCookie(cookieName, 'accepted', expirationDays);
            cookieBanner.style.opacity = '0';
            
            // Masquer le bandeau après l'animation
            setTimeout(() => {
                cookieBanner.style.display = 'none';
            }, 300);
        });
    }
});
</script>
<!-- FIN BANDEAU DE CONSENTEMENT -->
<!-- 🤖 CHATBOT (VISIBLE UNIQUEMENT PAR ADMIN) -->
<% if (isAdminUser) { %>
    <style>
        #chat-widget {
            position: fixed; bottom: 20px; right: 20px; z-index: 9999;
            font-family: 'Arial', sans-serif;
        }
        #chat-toggle {
            width: 60px; height: 60px; border-radius: 50%;
            background: #52566f; color: white; border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer;
            font-size: 24px; display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s;
        }
        #chat-toggle:hover { transform: scale(1.1); }
        
        #chat-box {
            display: none;
            width: 350px; height: 500px; /* Un peu plus haut */
            background: white; border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            flex-direction: column; overflow: hidden;
            position: absolute; bottom: 80px; right: 0;
            border: 1px solid #eee;
        }
        .chat-header {
            background: #52566f; color: white; padding: 15px;
            font-weight: bold; display: flex; justify-content: space-between;
            align-items: center;
        }
        .chat-messages {
            flex: 1; padding: 15px; overflow-y: auto;
            background: #f9f9f9; display: flex; flex-direction: column; gap: 12px;
        }
        .chat-input-area {
            padding: 10px; border-top: 1px solid #eee; display: flex; gap: 5px; background: #fff;
        }
        
        /* Styles des bulles de message */
        .message {
            padding: 10px 14px; border-radius: 15px; max-width: 85%; font-size: 14px;
            line-height: 1.4; word-wrap: break-word;
        }
        /* Message Utilisateur (Droite) */
        .message.user {
            background: #8f97c4; 
            color: white; 
            align-self: flex-end; /* IMPORTANT : Aligne à droite */
            border-bottom-right-radius: 2px;
            text-align: right;
        }
        /* Message Bot (Gauche) */
        .message.bot {
            background: #e9ecef; 
            color: #333; 
            align-self: flex-start; /* IMPORTANT : Aligne à gauche */
            border-bottom-left-radius: 2px;
        }
        
        /* Bouton d'action dans le chat */
        .chat-action-btn {
            display: inline-block; margin-top: 8px; padding: 6px 12px;
            background: #C4B990; color: black; text-decoration: none;
            border-radius: 6px; font-size: 12px; font-weight: bold;
            cursor: pointer; border: none; width: 100%; text-align: center;
        }
        .chat-action-btn:hover { background: #b3a579; }
    </style>

    <div id="chat-widget">
        <div id="chat-box">
            <div class="chat-header">
                <span>🤖 Assistant UAP</span>
                <span style="cursor:pointer; font-size: 1.2rem;" onclick="toggleChat()">✕</span>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="message bot">Bonjour ! Je suis votre assistant virtuel. Posez-moi une question ou demandez-moi de créer une annonce.</div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chatInput" class="form-control form-control-sm" placeholder="Posez votre question..." onkeypress="handleChatKey(event)">
                <button class="btn btn-sm btn-dark" onclick="sendMessage()"><i class="bi bi-send"></i></button>
            </div>
        </div>
        
        <button id="chat-toggle" onclick="toggleChat()">
            <i class="bi bi-chat-dots-fill"></i>
        </button>
    </div>

    <script>
        function toggleChat() {
            const box = document.getElementById('chat-box');
            if (box.style.display === 'flex') {
                box.style.display = 'none';
            } else {
                box.style.display = 'flex';
                // Focus sur l'input pour écrire direct
                setTimeout(() => document.getElementById('chatInput').focus(), 100);
            }
        }

        function handleChatKey(e) {
            if (e.key === 'Enter') sendMessage();
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text) return;

            // 1. Afficher message utilisateur (aligné à droite)
            addMessage(text, 'user');
            input.value = '';

            // 2. Afficher "..." (Bot réfléchit)
            const loadingId = addMessage('...', 'bot');

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text })
                });
                const data = await res.json();

                // 3. Supprimer "..." et afficher la réponse
                const loadingEl = document.querySelector(`[data-id="${loadingId}"]`);
                if(loadingEl) loadingEl.remove();

                addMessage(data.response, 'bot', data.action);

                // Si c'est une action auto-exécutable (sans bouton), on peut la lancer ici
                // Mais nous avons privilégié les boutons pour l'UX

            } catch (err) {
                console.error(err);
                addMessage("Désolé, une erreur de connexion est survenue.", 'bot');
            }
        }

        function addMessage(text, sender, action = null) {
            const div = document.createElement('div');
            const id = Date.now();
            div.className = `message ${sender}`;
            div.setAttribute('data-id', id);
            
            // Convertir markdown basique
            let formatted = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
            div.innerHTML = formatted;

            // Ajouter un bouton si une action est présente
            if (action) {
                if (action.type === 'link') {
                    // Lien externe ou interne (ex: Forgot Password)
                    div.innerHTML += `<br><a href="${action.url}" class="chat-action-btn">${action.text}</a>`;
                } else if (action.type === 'script' && action.label) {
                     // Bouton qui exécute un script (ex: showSection)
                     // Note: On utilise un attribut onclick sécurisé ou une fonction globale
                     const btn = document.createElement('button');
                     btn.className = 'chat-action-btn';
                     btn.innerText = action.label;
                     btn.onclick = function() { 
                         try { eval(action.code); } catch(e) { console.error(e); }
                         // Sur mobile, on ferme le chat après le clic pour voir le résultat
                         if(window.innerWidth < 768) toggleChat();
                     };
                     div.appendChild(document.createElement('br'));
                     div.appendChild(btn);
                     // On retourne ici pour ne pas écraser avec div.innerHTML
                     const container = document.getElementById('chatMessages');
                     container.appendChild(div);
                     container.scrollTop = container.scrollHeight;
                     return id;
                }
            }

            const container = document.getElementById('chatMessages');
            container.appendChild(div);
            // Scroll auto vers le bas
            container.scrollTop = container.scrollHeight;
            return id;
        }
    </script>
<% } %>
</body>
</html>


